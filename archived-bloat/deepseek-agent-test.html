<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek AI Agent Test | Te Kete Ako</title>
    <meta name="description" content="Test interface for DeepSeek AI integration with Te Kete Ako's GraphRAG system">
    <link rel="stylesheet" href="css/deepseek-agent-test.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
                        <header class="site-header no-print">
        <div class="nav-container">
            <a href="../index.html" class="nav-brand">Te Kete Ako</a>
            <nav class="main-nav">
                <ul>
                    <li>
                        <a href="../unit-plans.html">
                            <span class="nav-icon">📚</span>
                            <span class="nav-text-en">Unit Plans</span>
                            <span class="nav-text-mi" lang="mi">Ngā Waehere</span>
                        </a>
                    </li>
                    <li>
                        <a href="../teachers/index.html">
                            <span class="nav-icon">🧑‍🏫</span>
                            <span class="nav-text-en">Teachers</span>
                            <span class="nav-text-mi" lang="mi">Ngā Kaiako</span>
                        </a>
                    </li>
                    <li>
                        <a href="../lessons.html">
                            <span class="nav-icon">🎓</span>
                            <span class="nav-text-en">Lessons</span>
                            <span class="nav-text-mi" lang="mi">Ngā Akoranga</span>
                        </a>
                    </li>
                    <li>
                        <a href="../handouts.html">
                            <span class="nav-icon">📄</span>
                            <span class="nav-text-en">Handouts</span>
                            <span class="nav-text-mi" lang="mi">Ngā Rauemi</span>
                        </a>
                    </li>
                    <li>
                        <a href="../games.html">
                            <span class="nav-icon">🎮</span>
                            <span class="nav-text-en">Games</span>
                            <span class="nav-text-mi" lang="mi">Ngā Kēmu</span>  
                        </a>
                    </li>
                    <li class="auth-nav my-kete-link" style="display: none;">
                        <a href="../my-kete.html">
                            <span class="nav-icon">🧺</span>
                            My Kete
                        </a>
                    </li>
                    <li class="auth-nav">
                        <a href="../login.html" class="login-btn">
                            <span class="nav-icon">👤</span>
                            Login
                        </a>
                    </li>
                    <li class="auth-nav" style="display: none;">
                        <a href="../register-simple.html" class="register-btn">
                            <span class="nav-icon">📝</span>
                            Register
                        </a>
                    </li>
                </ul>
            </nav>
            <nav class="breadcrumbs no-print" aria-label="Breadcrumb">
                <ol id="breadcrumbs" class="breadcrumbs-list"></ol>
            </nav>
        </div>
    </header>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <h3>🔧 Configuration</h3>
            <div class="config-options">
                <label class="toggle-group">
                    <input type="checkbox" id="use-graphrag" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Use GraphRAG Enhancement</span>
                </label>
                
                <div class="select-group">
                    <label for="analysis-mode">Analysis Mode:</label>
                    <select id="analysis-mode">
                        <option value="educational">Educational (Balanced)</option>
                        <option value="cultural">Cultural Focus</option>
                        <option value="pedagogical">Pedagogical Focus</option>
                    </select>
                </div>

                <div class="select-group">
                    <label for="agent-type">Agent Type:</label>
                    <select id="agent-type">
                        <option value="advanced">Advanced (GraphRAG Integrated)</option>
                        <option value="simple">Simple (Direct Chat)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Example Queries -->
        <div class="examples-section">
            <h3>💡 Example Queries</h3>
            <div class="example-buttons">
                <button class="example-btn" data-query="How does whakapapa connect to mathematics teaching?">
                    🔗 Whakapapa & Mathematics
                </button>
                <button class="example-btn" data-query="Find resources for Year 8 systems thinking">
                    🎯 Y8 Systems Thinking
                </button>
                <button class="example-btn" data-query="How can I integrate Te Ao Māori in science lessons?">
                    🔬 Cultural Science Integration
                </button>
                <button class="example-btn" data-query="What assessment methods work for cultural content?">
                    📊 Cultural Assessment
                </button>
                <button class="example-btn" data-query="Explain the Treaty of Waitangi's mathematical concepts">
                    📜 Treaty Mathematics
                </button>
                <button class="example-btn" data-query="Create a lesson plan connecting traditional navigation to modern GPS">
                    🧭 Navigation Technology
                </button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container">
            <div class="chat-header">
                <h3>💬 DeepSeek Chat Interface</h3>
                <button id="clear-chat" class="clear-btn">Clear Chat</button>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <div class="system-message">
                    <div class="message-icon">🤖</div>
                    <div class="message-content">
                        <strong>Te Kete Ako DeepSeek Agent ready!</strong>
                        <p>I'm your AI assistant specialized in New Zealand education with authentic Te Ao Māori integration. Ask me anything about teaching, learning, or cultural integration.</p>
                        <div class="capabilities">
                            <span class="capability">📚 Educational Analysis</span>
                            <span class="capability">🌟 Cultural Sensitivity</span>
                            <span class="capability">🔍 GraphRAG Integration</span>
                            <span class="capability">🎯 NZ Curriculum</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="user-input" 
                        placeholder="Ask about teaching, learning, or cultural integration..."
                        rows="3"
                    ></textarea>
                    <button id="send-btn" class="send-btn">
                        <span class="btn-text">Send</span>
                        <span class="btn-icon">🚀</span>
                    </button>
                </div>
                <div class="input-info">
                    <small>💡 Try questions about cultural integration, pedagogy, or resource discovery</small>
                </div>
            </div>
        </div>

        <!-- Response Analysis -->
        <div class="analysis-panel" id="analysis-panel" style="display: none;">
            <h3>📊 Response Analysis</h3>
            <div class="analysis-content">
                <div class="metric-group">
                    <div class="metric">
                        <span class="metric-label">Enhanced Query:</span>
                        <span id="enhanced-query" class="metric-value">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">GraphRAG Results:</span>
                        <span id="graphrag-count" class="metric-value">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Processing Time:</span>
                        <span id="processing-time" class="metric-value">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Token Usage:</span>
                        <span id="token-usage" class="metric-value">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
                        <footer class="site-footer no-print">
        <div class="footer-content">
            <div class="footer-simple">
                <div class="footer-brand">
                    <h3>🧺 Te Kete Ako</h3>
                    <p>"Whaowhia te kete mātauranga" - Fill the basket of knowledge</p>
                </div>
                <div class="footer-links">
                    <a href="../unit-plans.html">Unit Plans</a>
                    <a href="../lessons.html">Lessons</a>
                    <a href="../handouts.html">Handouts</a>
                    <a href="../my-kete.html">My Kete</a>
                    <a href="../sitemap.html">Sitemap</a>
                    <a href="../orphans.html">Discover</a>
                </div>
            </div>
            <div class="footer-bottom">
                <span>© 2025 Te Kete Ako - Educational resources for Aotearoa New Zealand</span>
            </div>
        </div>
    </footer>
    </div>

    <script>
        // Global state
        let conversationHistory = [];
        let isProcessing = false;

        // DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-chat');
        const useGraphRAG = document.getElementById('use-graphrag');
        const analysisMode = document.getElementById('analysis-mode');
        const agentType = document.getElementById('agent-type');
        const statusDot = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const analysisPanel = document.getElementById('analysis-panel');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            setupEventListeners();
            updateUIState();
        });

        function setupEventListeners() {
            sendBtn.addEventListener('click', sendMessage);
            clearBtn.addEventListener('click', clearChat);
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Example buttons
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    userInput.value = this.dataset.query;
                    sendMessage();
                });
            });

            // Configuration changes
            agentType.addEventListener('change', updateUIState);
            useGraphRAG.addEventListener('change', updateUIState);
        }

        function updateUIState() {
            const isAdvanced = agentType.value === 'advanced';
            useGraphRAG.style.display = isAdvanced ? 'block' : 'none';
            analysisMode.style.display = isAdvanced ? 'block' : 'none';
            
            if (!isAdvanced) {
                useGraphRAG.checked = false;
                analysisPanel.style.display = 'none';
            }
        }

        async function testConnection() {
            try {
                statusDot.className = 'status-dot pending';
                statusText.textContent = 'Testing connection...';

                const response = await fetch('/.netlify/functions/deepseek-agent-simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'test' })
                });

                if (response.ok) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'DeepSeek Connected ✅';
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                statusDot.className = 'status-dot error';
                statusText.textContent = 'Connection Error ❌';
                console.error('Connection test failed:', error);
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isProcessing) return;

            isProcessing = true;
            updateSendButton(true);

            // Add user message
            addMessage('user', message);
            userInput.value = '';

            const startTime = Date.now();

            try {
                const endpoint = agentType.value === 'simple' 
                    ? '/.netlify/functions/deepseek-agent-simple'
                    : '/.netlify/functions/deepseek-agent';

                const requestBody = {
                    message: message,
                    conversation_history: conversationHistory
                };

                if (agentType.value === 'advanced') {
                    requestBody.use_graphrag = useGraphRAG.checked;
                    requestBody.analysis_mode = analysisMode.value;
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                const processingTime = Date.now() - startTime;

                if (data.success) {
                    addMessage('assistant', data.response);
                    
                    // Update conversation history
                    conversationHistory.push(
                        { role: 'user', content: message },
                        { role: 'assistant', content: data.response }
                    );

                    // Show analysis for advanced mode
                    if (agentType.value === 'advanced') {
                        updateAnalysisPanel(data, processingTime);
                    }
                } else {
                    addMessage('error', `Error: ${data.error}\n${data.message || ''}`);
                }

            } catch (error) {
                console.error('Send message error:', error);
                addMessage('error', `Connection error: ${error.message}`);
            } finally {
                isProcessing = false;
                updateSendButton(false);
            }
        }

        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const icon = type === 'user' ? '👤' : type === 'error' ? '⚠️' : '🤖';
            
            messageDiv.innerHTML = `
                <div class="message-icon">${icon}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessage(content) {
            // Convert markdown-style formatting to HTML
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function updateAnalysisPanel(data, processingTime) {
            document.getElementById('enhanced-query').textContent = 
                data.enhanced_query || 'N/A';
            
            document.getElementById('graphrag-count').textContent = 
                data.graphrag_results ? `${data.graphrag_results.resources_found} resources found` : 'N/A';
            
            document.getElementById('processing-time').textContent = 
                `${processingTime}ms`;
            
            document.getElementById('token-usage').textContent = 
                data.usage ? `${data.usage.total_tokens} tokens` : 'N/A';

            analysisPanel.style.display = 'block';
        }

        function updateSendButton(loading) {
            if (loading) {
                sendBtn.disabled = true;
                sendBtn.querySelector('.btn-text').textContent = 'Processing...';
                sendBtn.querySelector('.btn-icon').textContent = '⏳';
            } else {
                sendBtn.disabled = false;
                sendBtn.querySelector('.btn-text').textContent = 'Send';
                sendBtn.querySelector('.btn-icon').textContent = '🚀';
            }
        }

        function clearChat() {
            chatMessages.innerHTML = `
                <div class="system-message">
                    <div class="message-icon">🤖</div>
                    <div class="message-content">
                        <strong>Chat cleared - Te Kete Ako DeepSeek Agent ready!</strong>
                        <p>Ask me anything about teaching, learning, or cultural integration.</p>
                    </div>
                </div>
            `;
            conversationHistory = [];
            analysisPanel.style.display = 'none';
        }
    </script>

    <!-- Load Supabase Client -->
    <script src="js/supabase-client.js"></script>
    <!-- Load Auth UI -->
    <script src="js/auth-ui.js"></script>
</body>
</html>