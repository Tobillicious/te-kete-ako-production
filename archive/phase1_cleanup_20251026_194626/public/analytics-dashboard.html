<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Analytics Dashboard - Te Kete Ako</title>

<!-- UNIFIED DESIGN SYSTEM -->
<!-- PWA Manifest -->
<link href="/manifest.json" rel="manifest"/>
<meta content="#1a4d2e" name="theme-color"/>

<!-- CSS - UNIFIED PROFESSIONAL DESIGN SYSTEM (CONSOLIDATED) -->
<!-- ‚≠ê PROFESSIONAL SYSTEM FIRST - Core design tokens -->


<!-- ‚≠ê THEME SYSTEM (Tailwind + Ultimate Beauty) -->



<!-- ‚≠ê COMPONENT STYLES -->





<!-- ‚≠ê PRINT STYLES (media="print" = only for printing) -->



<!-- ‚≠ê TAILWIND (Loads second-to-last - utilities only, NO DUPLICATES) -->


<!-- ‚≠ê CASCADE FIX (Loads LAST - overrides conflicting variables) -->


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Wait for Supabase CDN to load before initializing singleton
    window.addEventListener('DOMContentLoaded', () => {
        if (!window.supabase) {
            // Log to monitoring instead of console
            if (window.posthog) {
                posthog.capture('supabase_cdn_error', {
                    message: 'Supabase CDN failed to load',
                    url: window.location.pathname
                });
            }
        }
    });
</script>
<script src="/js/supabase-singleton.js"></script>
<!-- My Kete Database Integration - loads after singleton -->
<script src="/js/my-kete-database.js"></script>
<!-- Navigation Loader Singleton - loads after supabase setup -->
<script src="/js/navigation-loader.js"></script>
<!-- Component Loader - centralized async component management -->
<script src="/js/component-loader.js"></script>
<meta name="mobile-web-app-capable" content="yes"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Te Kete Ako" name="apple-mobile-web-app-title"/>
<link href="/icons/icon-192x192.png" rel="apple-touch-icon"/>
<!-- ENHANCED SEARCH -->
<script src="/js/enhanced-search.js" defer></script>
<!-- MOBILE PERFORMANCE OPTIMIZER -->
<script src="/js/mobile-performance-optimizer.js" defer></script>
<!-- TOUCH TARGET AUDITOR -->
<script src="/js/touch-target-auditor.js" defer></script>
<!-- üé® ULTIMATE CULTURAL GESTURES - Framer Motion System -->
<script src="/js/framer-cultural-gestures-ultimate.js" defer></script>
<!-- Service Worker Registration -->
<script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ PWA: Service Worker registered!', registration);
                    })
                    .catch(error => {
                        // Log to monitoring instead of console
                        if (window.posthog) {
                            posthog.capture('pwa_service_worker_error', {
                                message: 'Service Worker registration failed',
                                error: error.message,
                                url: window.location.pathname
                            });
                        }
                    });
            });
        }
</script>

<meta name="robots" content="index, follow"/>
<meta name="googlebot" content="index, follow"/>
<meta name="theme-color" content="#1a4d2e"/>



<meta name="robots" content="index, follow"/>
<meta name="googlebot" content="index, follow"/>
<meta name="theme-color" content="#1a4d2e"/>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- UNIFIED DESIGN SYSTEM -->
<!-- PWA Manifest -->
<link href="/manifest.json" rel="manifest"/>
<meta content="#1a4d2e" name="theme-color"/>

<!-- CSS - UNIFIED PROFESSIONAL DESIGN SYSTEM (CONSOLIDATED) -->
<!-- ‚≠ê PROFESSIONAL SYSTEM FIRST - Core design tokens -->


<!-- ‚≠ê THEME SYSTEM (Tailwind + Ultimate Beauty) -->



<!-- ‚≠ê COMPONENT STYLES -->
    
    
    
    

<!-- ‚≠ê PRINT STYLES (media="print" = only for printing) -->
    


<!-- ‚≠ê TAILWIND (Loads second-to-last - utilities only, NO DUPLICATES) -->


<!-- ‚≠ê CASCADE FIX (Loads LAST - overrides conflicting variables) -->

<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìä Analytics Dashboard</h1>
            <p>Real-time insights into GraphRAG component usage and teacher engagement</p>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading analytics...</p>
            </div>
        </div>

        <div class="chart-container">
            <h2>üîó Most Clicked Recommendations (Last 7 Days)</h2>
            <div id="top-recommendations">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>

        <div class="chart-container">
            <h2>‚≠ê Recent Teacher Feedback</h2>
            <div id="recent-feedback" class="feedback-list">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üìà Component Performance</h2>
            <div id="component-performance">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';

        async function initDashboard() {
            // Initialize Supabase
            const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
            const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

            // Load stats
            await loadStats(supabase);
            await loadTopRecommendations(supabase);
            await loadRecentFeedback(supabase);
            await loadComponentPerformance(supabase);
        }

        async function loadStats(supabase) {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

            // Total page views
            const { count: pageViews } = await supabase
                .from('component_analytics')
                .select('*', { count: 'exact', head: true })
                .eq('component_type', 'page_view')
                .gte('timestamp', sevenDaysAgo);

            // Similar Resources clicks
            const { count: similarClicks } = await supabase
                .from('component_analytics')
                .select('*', { count: 'exact', head: true })
                .eq('component_type', 'similar_resources')
                .eq('user_action', 'click')
                .gte('timestamp', sevenDaysAgo);

            // Most Connected clicks
            const { count: connectedClicks } = await supabase
                .from('component_analytics')
                .select('*', { count: 'exact', head: true })
                .eq('component_type', 'most_connected')
                .eq('user_action', 'click')
                .gte('timestamp', sevenDaysAgo);

            // Average feedback rating
            const { data: feedbackData } = await supabase
                .from('teacher_feedback')
                .select('rating')
                .gte('timestamp', sevenDaysAgo);

            const avgRating = feedbackData && feedbackData.length > 0
                ? (feedbackData.reduce((sum, f) => sum + f.rating, 0) / feedbackData.length).toFixed(1)
                : 'N/A';

            // Render stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Page Views</span>
                        <span class="stat-card-icon">üëÅÔ∏è</span>
                    </div>
                    <div class="stat-card-value">${pageViews || 0}</div>
                    <div class="stat-card-change">Last 7 days</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Similar Resources Clicks</span>
                        <span class="stat-card-icon">üîó</span>
                    </div>
                    <div class="stat-card-value">${similarClicks || 0}</div>
                    <div class="stat-card-change">Last 7 days</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Most Connected Clicks</span>
                        <span class="stat-card-icon">‚ö°</span>
                    </div>
                    <div class="stat-card-value">${connectedClicks || 0}</div>
                    <div class="stat-card-change">Last 7 days</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Avg Feedback Rating</span>
                        <span class="stat-card-icon">‚≠ê</span>
                    </div>
                    <div class="stat-card-value">${avgRating}</div>
                    <div class="stat-card-change">${feedbackData?.length || 0} reviews</div>
                </div>
            `;

            document.getElementById('stats-grid').innerHTML = statsHtml;
        }

        async function loadTopRecommendations(supabase) {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

            const { data, error } = await supabase
                .from('component_analytics')
                .select('clicked_resource_path')
                .in('component_type', ['similar_resources', 'most_connected'])
                .eq('user_action', 'click')
                .gte('timestamp', sevenDaysAgo)
                .not('clicked_resource_path', 'is', null);

            if (error) {
                // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        return;
            }

            // Count clicks per resource
            const clickCounts = {};
            data.forEach(item => {
                clickCounts[item.clicked_resource_path] = (clickCounts[item.clicked_resource_path] || 0) + 1;
            });

            // Sort and take top 10
            const topResources = Object.entries(clickCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const html = topResources.length > 0
                ? `<ul class="top-resources-list">
                    ${topResources.map(([path, count]) => `
                        <li>
                            <span class="resource-name">${path}</span>
                            <span class="resource-stat">${count} clicks</span>
                        </li>
                    `).join('')}
                </ul>`
                : '<p class="text-center p-8" >No data available yet. Start using the components to see insights!</p>';

            document.getElementById('top-recommendations').innerHTML = html;
        }

        async function loadRecentFeedback(supabase) {
            const { data, error } = await supabase
                .from('teacher_feedback')
                .select('*')
                .order('timestamp', { ascending: false })
                .limit(10);

            if (error) {
                // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        return;
            }

            const html = data && data.length > 0
                ? data.map(fb => `
                    <div class="feedback-item">
                        <div class="feedback-rating">${'‚≠ê'.repeat(fb.rating)}</div>
                        ${fb.comment ? `<div class="feedback-comment">"${fb.comment}"</div>` : ''}
                        <div class="feedback-meta">
                            ${fb.feedback_type} ‚Ä¢ ${fb.resource_path} ‚Ä¢ ${new Date(fb.timestamp).toLocaleDateString()}
                        </div>
                    </div>
                `).join('')
                : '<p class="text-center p-8" >No feedback yet. Teachers will provide feedback as they use the platform!</p>';

            document.getElementById('recent-feedback').innerHTML = html;
        }

        async function loadComponentPerformance(supabase) {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

            const { data, error } = await supabase
                .from('component_analytics')
                .select('component_type, user_action')
                .gte('timestamp', sevenDaysAgo);

            if (error) {
                // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        return;
            }

            // Calculate metrics per component
            const metrics = {};
            data.forEach(item => {
                if (!metrics[item.component_type]) {
                    metrics[item.component_type] = { loaded: 0, clicks: 0, hovers: 0 };
                }
                if (item.user_action === 'component_loaded') metrics[item.component_type].loaded++;
                if (item.user_action === 'click') metrics[item.component_type].clicks++;
                if (item.user_action === 'hover_sustained') metrics[item.component_type].hovers++;
            });

            const html = Object.keys(metrics).length > 0
                ? `<ul class="top-resources-list">
                    ${Object.entries(metrics).map(([component, stats]) => `
                        <li>
                            <span class="resource-name">${component}</span>
                            <span class="resource-stat">
                                ${stats.loaded} loads ‚Ä¢ ${stats.clicks} clicks ‚Ä¢ ${stats.hovers} hovers
                            </span>
                        </li>
                    `).join('')}
                </ul>`
                : '<p class="text-center p-8" >No performance data yet!</p>';

            document.getElementById('component-performance').innerHTML = html;
        }

        // Initialize dashboard
        initDashboard();

        // Auto-refresh every 30 seconds
        setInterval(initDashboard, 30000);
    </script>
</body>
</html>

