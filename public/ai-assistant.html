<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Assistant - Te Kete Ako</title>
    <link rel="stylesheet" href="/css/te-kete-ultimate-beauty-system.css">
    <link rel="stylesheet" href="/css/te-kete-professional.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .ai-container {
            max-width: 900px;
            width: 95%;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .ai-header {
            background: linear-gradient(135deg, #1a4d2e, #0f2818);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .ai-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .ai-header p {
            margin: 0;
            opacity: 0.9;
        }

        .chat-area {
            height: 500px;
            overflow-y: auto;
            padding: 2rem;
            background: #f9fafb;
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .message-content {
            max-width: 70%;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            line-height: 1.6;
        }

        .message.ai .message-content {
            background: white;
            color: #1f2937;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .quick-actions {
            padding: 1rem 2rem;
            background: white;
            border-top: 2px solid #e5e7eb;
        }

        .quick-actions-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .quick-action-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            text-align: left;
        }

        .quick-action-btn:hover {
            background: #e5e7eb;
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .input-area {
            padding: 1.5rem 2rem;
            background: white;
            border-top: 2px solid #e5e7eb;
        }

        .input-form {
            display: flex;
            gap: 1rem;
        }

        .input-field {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .send-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .resource-card {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 4px solid #3b82f6;
        }

        .resource-card-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.25rem;
        }

        .resource-card-meta {
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="ai-container">
        <div class="ai-header">
            <h1>üß† AI Learning Assistant</h1>
            <p>Powered by 5 specialized AI agents + GraphRAG (242,079 relationships!)</p>
        </div>

        <div class="chat-area" id="chat-area">
            <div class="message ai">
                <div class="message-avatar">üåø</div>
                <div class="message-content">
                    <strong>Kia ora!</strong> I'm your AI Learning Assistant, powered by Te Kete Ako's GraphRAG intelligence.
                    <br><br>
                    I can help you:
                    <ul style="margin: 0.5rem 0;">
                        <li>üéØ Generate personalized learning paths</li>
                        <li>üìö Find related resources automatically</li>
                        <li>üåø Integrate cultural knowledge appropriately</li>
                        <li>üìä Create adaptive assessments</li>
                        <li>‚ö° Optimize student engagement</li>
                    </ul>
                    Try a quick action below, or ask me anything!
                </div>
            </div>
        </div>

        <div class="quick-actions">
            <div class="quick-actions-title">üöÄ Quick Actions:</div>
            <div class="quick-actions-grid">
                <button class="quick-action-btn" onclick="sendQuickAction('learning_path')">
                    üéØ Generate Learning Path
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('find_resources')">
                    üîç Find Related Resources
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('cultural_integration')">
                    üåø Add Cultural Elements
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('assessment')">
                    üìä Create Assessment
                </button>
            </div>
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <span>AI thinking...</span>
        </div>

        <div class="input-area">
            <form class="input-form" id="chat-form">
                <input 
                    type="text" 
                    class="input-field" 
                    id="user-input" 
                    placeholder="Ask me anything... e.g., 'Find Y9 Science lessons about ecosystems with MƒÅori context'"
                    required
                >
                <button type="submit" class="send-btn" id="send-btn">
                    Send üöÄ
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        const chatArea = document.getElementById('chat-area');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');

        // Initialize Supabase
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';
        
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Add user message to chat
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${isUser ? 'üë§' : 'üåø'}</div>
                <div class="message-content">${content}</div>
            `;
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Process user query with GraphRAG intelligence
        async function processQuery(query) {
            try {
                // For now, use GraphRAG directly (until AI Orchestrator env vars are set)
                // This gives intelligent responses without external API keys!
                
                addMessage(query, true);
                typingIndicator.classList.add('active');
                sendBtn.disabled = true;

                // Smart query parsing
                const queryLower = query.toLowerCase();
                let response = '';

                // Pattern 1: Find resources queries
                if (queryLower.includes('find') || queryLower.includes('show') || queryLower.includes('search')) {
                    response = await findResourcesWithGraphRAG(query);
                }
                // Pattern 2: Learning path queries
                else if (queryLower.includes('learning path') || queryLower.includes('sequence') || queryLower.includes('plan')) {
                    response = await generateLearningPathWithGraphRAG(query);
                }
                // Pattern 3: Cultural integration queries
                else if (queryLower.includes('cultural') || queryLower.includes('mƒÅori') || queryLower.includes('whakataukƒ´')) {
                    response = await findCulturalResourcesWithGraphRAG(query);
                }
                // Default: Smart search
                else {
                    response = await smartSearchGraphRAG(query);
                }

                typingIndicator.classList.remove('active');
                addMessage(response);

            } catch (error) {
                console.error('Query error:', error);
                typingIndicator.classList.remove('active');
                addMessage('‚ùå Sorry, I encountered an error. Please try again!');
            } finally {
                sendBtn.disabled = false;
                userInput.value = '';
            }
        }

        // GraphRAG-powered resource finding
        async function findResourcesWithGraphRAG(query) {
            // Extract keywords
            const keywords = extractKeywords(query);
            
            // Query GraphRAG
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, year_level, subject, cultural_context, resource_type')
                .or(`title.ilike.%${keywords[0]}%,content_preview.ilike.%${keywords[0]}%`)
                .order('quality_score', { ascending: false })
                .limit(8);

            if (error || !data || data.length === 0) {
                return `I searched GraphRAG but couldn't find resources matching "${query}". Try different keywords or browse our <a href="/browse-lessons.html">lesson catalog</a>!`;
            }

            let response = `üéØ <strong>Found ${data.length} excellent resources for you!</strong><br><br>`;
            
            data.forEach(resource => {
                const badges = [];
                if (resource.quality_score >= 90) badges.push('üèÜ Q' + resource.quality_score);
                if (resource.cultural_context) badges.push('üåø Cultural');
                
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        <a href="${resource.file_path}" target="_blank">${resource.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${resource.resource_type} ‚Ä¢ ${resource.year_level || 'All Years'} ‚Ä¢ ${resource.subject}
                        ${badges.length > 0 ? ' ‚Ä¢ ' + badges.join(' ') : ''}
                    </div>
                </div>`;
            });

            response += `<br><em>These were selected from our GraphRAG knowledge graph of 17,363 resources!</em>`;
            
            return response;
        }

        // Generate learning path with GraphRAG
        async function generateLearningPathWithGraphRAG(query) {
            // Extract subject and year level
            const yearMatch = query.match(/year?\s*(\d+)|y(\d+)/i);
            const yearLevel = yearMatch ? `Year ${yearMatch[1] || yearMatch[2]}` : null;

            // Find high-quality lessons for the topic
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, year_level')
                .eq('resource_type', 'Lesson')
                .gte('quality_score', 85)
                .order('quality_score', { ascending: false })
                .limit(6);

            if (!data || data.length === 0) {
                return `I can help you create a learning path! However, I need more specific information. What subject and year level are you planning for?`;
            }

            let response = `üéØ <strong>Here's a suggested learning sequence:</strong><br><br>`;
            
            data.forEach((lesson, index) => {
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        Step ${index + 1}: <a href="${lesson.file_path}" target="_blank">${lesson.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${lesson.year_level} ‚Ä¢ Quality ${lesson.quality_score}
                    </div>
                </div>`;
            });

            response += `<br><em>üí° This sequence is based on GraphRAG relationship analysis. Each lesson connects to the next!</em>`;
            
            return response;
        }

        // Find cultural resources
        async function findCulturalResourcesWithGraphRAG(query) {
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, year_level, subject')
                .eq('cultural_context', true)
                .gte('quality_score', 85)
                .order('quality_score', { ascending: false })
                .limit(8);

            if (!data || data.length === 0) {
                return `I can help with cultural integration! We have 7,550 culturally-integrated resources. Try being more specific about the subject or year level.`;
            }

            let response = `üåø <strong>Found ${data.length} culturally-excellent resources!</strong><br><br>`;
            
            data.forEach(resource => {
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        <a href="${resource.file_path}" target="_blank">${resource.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${resource.subject} ‚Ä¢ ${resource.year_level} ‚Ä¢ üèÜ Q${resource.quality_score} ‚Ä¢ üåø Cultural Excellence
                    </div>
                </div>`;
            });

            response += `<br><em>All resources validated for cultural authenticity (43.5% of our 17,363 total resources are culturally integrated!)</em>`;
            
            return response;
        }

        // Smart search GraphRAG
        async function smartSearchGraphRAG(query) {
            const keywords = extractKeywords(query);
            
            // Multi-table search
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, resource_type, subject')
                .or(`title.ilike.%${keywords[0]}%,subject.ilike.%${keywords[0]}%`)
                .gte('quality_score', 80)
                .order('quality_score', { ascending: false })
                .limit(6);

            if (!data || data.length === 0) {
                return `I understand you're asking about "${query}". While I don't have a direct match, I can help you:
                <br><br>
                ‚Ä¢ Browse our <a href="/browse-lessons.html">1,855 lessons</a>
                <br>
                ‚Ä¢ Explore <a href="/cultural-hub.html">7,550 cultural resources</a>
                <br>
                ‚Ä¢ Search by <a href="/science-hub.html">subject hub</a>
                <br><br>
                Or try asking more specifically about a subject, year level, or topic!`;
            }

            let response = `üîç <strong>Here's what I found:</strong><br><br>`;
            
            data.forEach(resource => {
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        <a href="${resource.file_path}" target="_blank">${resource.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${resource.resource_type} ‚Ä¢ ${resource.subject} ‚Ä¢ Q${resource.quality_score}
                    </div>
                </div>`;
            });
            
            return response;
        }

        // Extract keywords from query
        function extractKeywords(query) {
            const stopWords = ['find', 'show', 'get', 'me', 'the', 'a', 'an', 'with', 'for', 'about', 'on'];
            return query.toLowerCase()
                .split(/\s+/)
                .filter(word => !stopWords.includes(word) && word.length > 2);
        }

        // Quick actions
        window.sendQuickAction = function(action) {
            const actions = {
                'learning_path': "Generate a learning path for Year 9 Science about ecosystems with MƒÅori cultural integration",
                'find_resources': "Find high-quality lessons about fractions for Year 7",
                'cultural_integration': "Show me culturally-integrated Mathematics resources",
                'assessment': "Help me create an assessment for Year 8 Digital Technologies"
            };
            
            userInput.value = actions[action];
            chatForm.dispatchEvent(new Event('submit'));
        };

        // Form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = userInput.value.trim();
            if (!query) return;
            
            await processQuery(query);
        });

        // Auto-focus input
        userInput.focus();
    </script>
</body>
</html>

