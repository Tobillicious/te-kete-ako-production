<!DOCTYPE html>
<html lang="en">
<head>
    <title>AI Learning Assistant - Te Kete Ako</title>

<!-- UNIFIED DESIGN SYSTEM -->
<!-- PWA Manifest -->
<link href="/manifest.json" rel="manifest"/>
<meta content="#1a4d2e" name="theme-color"/>

<!-- CSS - UNIFIED PROFESSIONAL DESIGN SYSTEM (CONSOLIDATED) -->
<!-- ‚≠ê PROFESSIONAL SYSTEM FIRST - Core design tokens -->
<link rel="stylesheet" href="/css/professionalization-system.css">

<!-- ‚≠ê THEME SYSTEM (Tailwind + Ultimate Beauty) -->
<link rel="stylesheet" href="/css/te-kete-professional.css"/>
<link rel="stylesheet" href="/css/te-kete-ultimate-beauty-system.css"/>

<!-- ‚≠ê COMPONENT STYLES -->
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/navigation-standard.css">
<link rel="stylesheet" href="/css/mobile-revolution.css">
<link rel="stylesheet" href="/css/mobile-first-classroom-tablets.css"/>

<!-- ‚≠ê PRINT STYLES (media="print" = only for printing) -->
<link rel="stylesheet" href="/css/print.css" media="print"/>
<link rel="stylesheet" href="/css/print-professional.css" media="print"/>

<!-- ‚≠ê TAILWIND (Loads second-to-last - utilities only, NO DUPLICATES) -->
<link rel="stylesheet" href="/css/tailwind.css">

<!-- ‚≠ê CASCADE FIX (Loads LAST - overrides conflicting variables) -->
<link rel="stylesheet" href="/css/cascade-fix.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Wait for Supabase CDN to load before initializing singleton
    window.addEventListener('DOMContentLoaded', () => {
        if (!window.supabase) {
            // Log to monitoring instead of console
            if (window.posthog) {
                posthog.capture('supabase_cdn_error', {
                    message: 'Supabase CDN failed to load',
                    url: window.location.pathname
                });
            }
        }
    });
</script>
<script src="/js/supabase-singleton.js"></script>
<!-- My Kete Database Integration - loads after singleton -->
<script src="/js/my-kete-database.js"></script>
<!-- Navigation Loader Singleton - loads after supabase setup -->
<script src="/js/navigation-loader.js"></script>
<!-- Component Loader - centralized async component management -->
<script src="/js/component-loader.js"></script>
<meta name="mobile-web-app-capable" content="yes"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Te Kete Ako" name="apple-mobile-web-app-title"/>
<link href="/icons/icon-192x192.png" rel="apple-touch-icon"/>
<!-- ENHANCED SEARCH -->
<script src="/js/enhanced-search.js" defer></script>
<!-- MOBILE PERFORMANCE OPTIMIZER -->
<script src="/js/mobile-performance-optimizer.js" defer></script>
<!-- TOUCH TARGET AUDITOR -->
<script src="/js/touch-target-auditor.js" defer></script>
<!-- üé® ULTIMATE CULTURAL GESTURES - Framer Motion System -->
<script src="/js/framer-cultural-gestures-ultimate.js" defer></script>
<!-- Service Worker Registration -->
<script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ PWA: Service Worker registered!', registration);
                    })
                    .catch(error => {
                        // Log to monitoring instead of console
                        if (window.posthog) {
                            posthog.capture('pwa_service_worker_error', {
                                message: 'Service Worker registration failed',
                                error: error.message,
                                url: window.location.pathname
                            });
                        }
                    });
            });
        }
</script>

<meta name="robots" content="index, follow"/>
<meta name="googlebot" content="index, follow"/>
<meta name="theme-color" content="#1a4d2e"/>



<meta name="robots" content="index, follow"/>
<meta name="googlebot" content="index, follow"/>
<meta name="theme-color" content="#1a4d2e"/>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Performance Optimizations -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a4d2e">

<!-- DNS Prefetch for external resources -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">

<!-- Preconnect for critical resources -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<!-- Resource hints -->
<link rel="preload" href="/css/professionalization-system.css" as="style">
<link rel="preload" href="/js/component-loader.js" as="script">

<!-- UNIFIED DESIGN SYSTEM -->
<!-- PWA Manifest -->
<link href="/manifest.json" rel="manifest"/>
<meta content="#1a4d2e" name="theme-color"/>

<!-- CSS - UNIFIED PROFESSIONAL DESIGN SYSTEM (CONSOLIDATED) -->
<!-- ‚≠ê PROFESSIONAL SYSTEM FIRST - Core design tokens -->
<link rel="stylesheet" href="/css/professionalization-system.css">

<!-- ‚≠ê THEME SYSTEM (Tailwind + Ultimate Beauty) -->
<link rel="stylesheet" href="/css/te-kete-professional.css"/>
<link rel="stylesheet" href="/css/te-kete-ultimate-beauty-system.css"/>

<!-- ‚≠ê COMPONENT STYLES -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/navigation-standard.css">
    <link rel="stylesheet" href="/css/mobile-revolution.css">
    <link rel="stylesheet" href="/css/mobile-first-classroom-tablets.css"/>

<!-- ‚≠ê PRINT STYLES (media="print" = only for printing) -->
    <link rel="stylesheet" href="/css/print.css" media="print"/>
<link rel="stylesheet" href="/css/print-professional.css" media="print"/>

<!-- ‚≠ê TAILWIND (Loads second-to-last - utilities only, NO DUPLICATES) -->
<link rel="stylesheet" href="/css/tailwind.css">

<!-- ‚≠ê CASCADE FIX (Loads LAST - overrides conflicting variables) -->
<link rel="stylesheet" href="/css/cascade-fix.css">
<body>
    <!-- Navigation -->
    <header class="site-header" style="top: 0; left: 0; right: 0; z-index: 1000; background: rgba(27, 67, 50, 0.95); backdrop-filter: blur(10px);">
        <div class="nav-container mx-auto" class="nav-container mx-auto" <a href="/index.html" class="nav-container mx-auto" >Te Kete Ako</a>
            <nav class="main-nav" style="gap: 2rem;">
                <a href="/lessons.html" style="color: white; text-decoration: none; opacity: 0.9;">üìö Lessons</a>
                <a href="/handouts.html" style="color: white; text-decoration: none; opacity: 0.9;">üìÑ Handouts</a>
                <a href="/teachers/index.html" style="color: white; text-decoration: none; opacity: 0.9;">üßë‚Äçüè´ Teachers</a>
                <a href="/index.html" style="color: white; text-decoration: none; opacity: 0.9;">üè† Home</a>
            </nav>
        </div>
    </header>

    <div class="ai-container" style="margin-top: 60px;">
        <div class="ai-header">
            <h1>üß† AI Learning Assistant</h1>
            <p>Powered by 5 specialized AI agents + GraphRAG (242,079 relationships!)</p>
        </div>

        <div class="chat-area" id="chat-area">
            <div class="message ai">
                <div class="message-avatar">üåø</div>
                <div class="message-content">
                    <strong>Kia ora!</strong> I'm your AI Learning Assistant, powered by Te Kete Ako's GraphRAG intelligence.
                    <br><br>
                    I can help you:
                    <ul class="m-0" style="margin: 0.5rem 0;"
                        <li>üéØ Generate personalized learning paths</li>
                        <li>üìö Find related resources automatically</li>
                        <li>üåø Integrate cultural knowledge appropriately</li>
                        <li>üìä Create adaptive assessments</li>
                        <li>‚ö° Optimize student engagement</li>
                    </ul>
                    Try a quick action below, or ask me anything!
                </div>
            </div>
        </div>

        <div class="quick-actions">
            <div class="quick-actions-title">üöÄ Quick Actions:</div>
            <div class="quick-actions-grid">
                <button class="quick-action-btn" onclick="sendQuickAction('learning_path')">
                    üéØ Generate Learning Path
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('find_resources')">
                    üîç Find Related Resources
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('cultural_integration')">
                    üåø Add Cultural Elements
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('assessment')">
                    üìä Create Assessment
                </button>
            </div>
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <span>AI thinking...</span>
        </div>

        <div class="input-area">
            <form class="input-form" id="chat-form">
                <input 
                    type="text" 
                    class="input-field" 
                    id="user-input" 
                    placeholder="Ask me anything... e.g., 'Find Y9 Science lessons about ecosystems with MƒÅori context'"
                    required
                >
                <button type="submit" class="send-btn" id="send-btn">
                    Send üöÄ
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        const chatArea = document.getElementById('chat-area');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');

        // Initialize Supabase
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';
        
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Add user message to chat
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${isUser ? 'üë§' : 'üåø'}</div>
                <div class="message-content">${content}</div>
            `;
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Process user query with GraphRAG intelligence
        async function processQuery(query) {
            try {
                // For now, use GraphRAG directly (until AI Orchestrator env vars are set)
                // This gives intelligent responses without external API keys!
                
                addMessage(query, true);
                typingIndicator.classList.add('active');
                sendBtn.disabled = true;

                // Smart query parsing
                const queryLower = query.toLowerCase();
                let response = '';

                // Pattern 1: Find resources queries
                if (queryLower.includes('find') || queryLower.includes('show') || queryLower.includes('search')) {
                    response = await findResourcesWithGraphRAG(query);
                }
                // Pattern 2: Learning path queries
                else if (queryLower.includes('learning path') || queryLower.includes('sequence') || queryLower.includes('plan')) {
                    response = await generateLearningPathWithGraphRAG(query);
                }
                // Pattern 3: Cultural integration queries
                else if (queryLower.includes('cultural') || queryLower.includes('mƒÅori') || queryLower.includes('whakataukƒ´')) {
                    response = await findCulturalResourcesWithGraphRAG(query);
                }
                // Default: Smart search
                else {
                    response = await smartSearchGraphRAG(query);
                }

                typingIndicator.classList.remove('active');
                addMessage(response);

            } catch (error) {
                // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        typingIndicator.classList.remove('active');
                addMessage('‚ùå Sorry, I encountered an error. Please try again!');
            } finally {
                sendBtn.disabled = false;
                userInput.value = '';
            }
        }

        // GraphRAG-powered resource finding
        async function findResourcesWithGraphRAG(query) {
            // Extract keywords
            const keywords = extractKeywords(query);
            
            // Query GraphRAG
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, year_level, subject, cultural_context, resource_type')
                .or(`title.ilike.%${keywords[0]}%,content_preview.ilike.%${keywords[0]}%`)
                .order('quality_score', { ascending: false })
                .limit(8);

            if (error || !data || data.length === 0) {
                return `I searched GraphRAG but couldn't find resources matching "${query}". Try different keywords or browse our <a href="/browse-lessons.html">lesson catalog</a>!`;
            }

            let response = `üéØ <strong>Found ${data.length} excellent resources for you!</strong><br><br>`;
            
            data.forEach(resource => {
                const badges = [];
                if (resource.quality_score >= 90) badges.push('üèÜ Q' + resource.quality_score);
                if (resource.cultural_context) badges.push('üåø Cultural');
                
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        <a href="${resource.file_path}" target="_blank">${resource.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${resource.resource_type} ‚Ä¢ ${resource.year_level || 'All Years'} ‚Ä¢ ${resource.subject}
                        ${badges.length > 0 ? ' ‚Ä¢ ' + badges.join(' ') : ''}
                    </div>
                </div>`;
            });

            response += `<br><em>These were selected from our GraphRAG knowledge graph of 17,363 resources!</em>`;
            
            return response;
        }

        // Generate learning path with GraphRAG
        async function generateLearningPathWithGraphRAG(query) {
            // Extract subject and year level
            const yearMatch = query.match(/year?\s*(\d+)|y(\d+)/i);
            const yearLevel = yearMatch ? `Year ${yearMatch[1] || yearMatch[2]}` : null;

            // Find high-quality lessons for the topic
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, year_level')
                .eq('resource_type', 'Lesson')
                .gte('quality_score', 85)
                .order('quality_score', { ascending: false })
                .limit(6);

            if (!data || data.length === 0) {
                return `I can help you create a learning path! However, I need more specific information. What subject and year level are you planning for?`;
            }

            let response = `üéØ <strong>Here's a suggested learning sequence:</strong><br><br>`;
            
            data.forEach((lesson, index) => {
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        Step ${index + 1}: <a href="${lesson.file_path}" target="_blank">${lesson.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${lesson.year_level} ‚Ä¢ Quality ${lesson.quality_score}
                    </div>
                </div>`;
            });

            response += `<br><em>üí° This sequence is based on GraphRAG relationship analysis. Each lesson connects to the next!</em>`;
            
            return response;
        }

        // Find cultural resources
        async function findCulturalResourcesWithGraphRAG(query) {
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, year_level, subject')
                .eq('cultural_context', true)
                .gte('quality_score', 85)
                .order('quality_score', { ascending: false })
                .limit(8);

            if (!data || data.length === 0) {
                return `I can help with cultural integration! We have 7,550 culturally-integrated resources. Try being more specific about the subject or year level.`;
            }

            let response = `üåø <strong>Found ${data.length} culturally-excellent resources!</strong><br><br>`;
            
            data.forEach(resource => {
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        <a href="${resource.file_path}" target="_blank">${resource.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${resource.subject} ‚Ä¢ ${resource.year_level} ‚Ä¢ üèÜ Q${resource.quality_score} ‚Ä¢ üåø Cultural Excellence
                    </div>
                </div>`;
            });

            response += `<br><em>All resources validated for cultural authenticity (43.5% of our 17,363 total resources are culturally integrated!)</em>`;
            
            return response;
        }

        // Smart search GraphRAG
        async function smartSearchGraphRAG(query) {
            const keywords = extractKeywords(query);
            
            // Multi-table search
            const { data, error } = await supabase
                .from('graphrag_resources')
                .select('file_path, title, quality_score, resource_type, subject')
                .or(`title.ilike.%${keywords[0]}%,subject.ilike.%${keywords[0]}%`)
                .gte('quality_score', 80)
                .order('quality_score', { ascending: false })
                .limit(6);

            if (!data || data.length === 0) {
                return `I understand you're asking about "${query}". While I don't have a direct match, I can help you:
                <br><br>
                ‚Ä¢ Browse our <a href="/browse-lessons.html">1,855 lessons</a>
                <br>
                ‚Ä¢ Explore <a href="/cultural-hub.html">7,550 cultural resources</a>
                <br>
                ‚Ä¢ Search by <a href="/science-hub.html">subject hub</a>
                <br><br>
                Or try asking more specifically about a subject, year level, or topic!`;
            }

            let response = `üîç <strong>Here's what I found:</strong><br><br>`;
            
            data.forEach(resource => {
                response += `<div class="resource-card">
                    <div class="resource-card-title">
                        <a href="${resource.file_path}" target="_blank">${resource.title}</a>
                    </div>
                    <div class="resource-card-meta">
                        ${resource.resource_type} ‚Ä¢ ${resource.subject} ‚Ä¢ Q${resource.quality_score}
                    </div>
                </div>`;
            });
            
            return response;
        }

        // Extract keywords from query
        function extractKeywords(query) {
            const stopWords = ['find', 'show', 'get', 'me', 'the', 'a', 'an', 'with', 'for', 'about', 'on'];
            return query.toLowerCase()
                .split(/\s+/)
                .filter(word => !stopWords.includes(word) && word.length > 2);
        }

        // Quick actions
        window.sendQuickAction = function(action) {
            const actions = {
                'learning_path': "Generate a learning path for Year 9 Science about ecosystems with MƒÅori cultural integration",
                'find_resources': "Find high-quality lessons about fractions for Year 7",
                'cultural_integration': "Show me culturally-integrated Mathematics resources",
                'assessment': "Help me create an assessment for Year 8 Digital Technologies"
            };
            
            userInput.value = actions[action];
            chatForm.dispatchEvent(new Event('submit'));
        };

        // Form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = userInput.value.trim();
            if (!query) return;
            
            await processQuery(query);
        });

        // Auto-focus input
        userInput.focus();
    </script>

    <!-- Footer -->
    <footer style="color: white; margin-top: 2rem; ">
        <p lang="mi">"Whaowhia te kete mƒÅtauranga"</p>
        <p style="opacity: 0.9; ">Fill the basket of knowledge</p>
        <div style="justify-content: center; gap: 2rem; flex-wrap: wrap;">
            <a href="/index.html" style="color: white; opacity: 0.8; text-decoration: none;">Home</a>
            <a href="/lessons.html" style="color: white; opacity: 0.8; text-decoration: none;">Lessons</a>
            <a href="/handouts.html" style="color: white; opacity: 0.8; text-decoration: none;">Handouts</a>
            <a href="/teachers/index.html" style="color: white; opacity: 0.8; text-decoration: none;">Teachers</a>
        </div>
        <p style="font-size: 0.875rem; opacity: 0.7; margin-top: 1rem;">¬© 2025 Te Kete Ako | Honoring mƒÅtauranga MƒÅori in education</p>
    </footer>
</body>
</html>

