<!DOCTYPE html>
<html lang="en">
<head>
    <title>Analytics Dashboard - Te Kete Ako</title>
<!-- SEO TAGS - Open Graph, Twitter Cards, Canonical URL -->
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://tekete.netlify.app/analytics-dashboard.html"/>
<meta property="og:title" content="Analytics Dashboard - Te Kete Ako"/>
<meta property="og:description" content="World-class educational resources integrating mƒÅtauranga MƒÅori with modern pedagogy"/>
<meta property="og:image" content="https://tekete.netlify.app/images/og-image.jpg"/>
<meta property="og:image:width" content="1200"/>
<meta property="og:image:height" content="630"/>
<meta property="og:image:alt" content="Te Kete Ako - Educational Platform"/>
<meta property="og:site_name" content="Te Kete Ako"/>
<meta property="og:locale" content="en_NZ"/>

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:url" content="https://tekete.netlify.app/analytics-dashboard.html"/>
<meta name="twitter:title" content="Analytics Dashboard - Te Kete Ako"/>
<meta name="twitter:description" content="World-class educational resources integrating mƒÅtauranga MƒÅori with modern pedagogy"/>
<meta name="twitter:image" content="https://tekete.netlify.app/images/twitter-card.jpg"/>
<meta name="twitter:image:alt" content="Te Kete Ako - Educational Platform"/>
<meta name="twitter:site" content="@TeKeteAko"/>
<meta name="twitter:creator" content="@TeKeteAko"/>

<!-- Canonical URL -->
<link rel="canonical" href="https://tekete.netlify.app/analytics-dashboard.html"/>

<!-- Additional SEO -->
<meta name="robots" content="index, follow"/>
<meta name="googlebot" content="index, follow"/>
<meta name="theme-color" content="#1a4d2e"/>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- UNIFIED DESIGN SYSTEM -->
<!-- PWA Manifest -->
<link href="/manifest.json" rel="manifest"/>
<meta content="#1a4d2e" name="theme-color"/>

<!-- CSS - UNIFIED PROFESSIONAL DESIGN SYSTEM (CONSOLIDATED) -->
<!-- ‚≠ê PROFESSIONAL SYSTEM FIRST - Core design tokens -->
<link rel="stylesheet" href="/css/professionalization-system.css">

<!-- ‚≠ê THEME SYSTEM (Tailwind + Ultimate Beauty) -->
<link rel="stylesheet" href="/css/te-kete-professional.css"/>
<link rel="stylesheet" href="/css/te-kete-ultimate-beauty-system.css"/>

<!-- ‚≠ê COMPONENT STYLES -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/navigation-standard.css">
    <link rel="stylesheet" href="/css/mobile-revolution.css">
    <link rel="stylesheet" href="/css/mobile-first-classroom-tablets.css"/>

<!-- ‚≠ê PRINT STYLES (media="print" = only for printing) -->
    <link rel="stylesheet" href="/css/print.css" media="print"/>
<link rel="stylesheet" href="/css/print-professional.css" media="print"/>

<!-- ‚≠ê TAILWIND (Loads second-to-last - utilities only, NO DUPLICATES) -->
<link rel="stylesheet" href="/css/tailwind.css">

<!-- ‚≠ê CASCADE FIX (Loads LAST - overrides conflicting variables) -->
<link rel="stylesheet" href="/css/cascade-fix.css">
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìä Analytics Dashboard</h1>
            <p>Real-time insights into GraphRAG component usage and teacher engagement</p>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading analytics...</p>
            </div>
        </div>

        <div class="chart-container">
            <h2>üîó Most Clicked Recommendations (Last 7 Days)</h2>
            <div id="top-recommendations">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>

        <div class="chart-container">
            <h2>‚≠ê Recent Teacher Feedback</h2>
            <div id="recent-feedback" class="feedback-list">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üìà Component Performance</h2>
            <div id="component-performance">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';

        async function initDashboard() {
            // Initialize Supabase
            const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
            const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

            // Load stats
            await loadStats(supabase);
            await loadTopRecommendations(supabase);
            await loadRecentFeedback(supabase);
            await loadComponentPerformance(supabase);
        }

        async function loadStats(supabase) {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

            // Total page views
            const { count: pageViews } = await supabase
                .from('component_analytics')
                .select('*', { count: 'exact', head: true })
                .eq('component_type', 'page_view')
                .gte('timestamp', sevenDaysAgo);

            // Similar Resources clicks
            const { count: similarClicks } = await supabase
                .from('component_analytics')
                .select('*', { count: 'exact', head: true })
                .eq('component_type', 'similar_resources')
                .eq('user_action', 'click')
                .gte('timestamp', sevenDaysAgo);

            // Most Connected clicks
            const { count: connectedClicks } = await supabase
                .from('component_analytics')
                .select('*', { count: 'exact', head: true })
                .eq('component_type', 'most_connected')
                .eq('user_action', 'click')
                .gte('timestamp', sevenDaysAgo);

            // Average feedback rating
            const { data: feedbackData } = await supabase
                .from('teacher_feedback')
                .select('rating')
                .gte('timestamp', sevenDaysAgo);

            const avgRating = feedbackData && feedbackData.length > 0
                ? (feedbackData.reduce((sum, f) => sum + f.rating, 0) / feedbackData.length).toFixed(1)
                : 'N/A';

            // Render stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Page Views</span>
                        <span class="stat-card-icon">üëÅÔ∏è</span>
                    </div>
                    <div class="stat-card-value">${pageViews || 0}</div>
                    <div class="stat-card-change">Last 7 days</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Similar Resources Clicks</span>
                        <span class="stat-card-icon">üîó</span>
                    </div>
                    <div class="stat-card-value">${similarClicks || 0}</div>
                    <div class="stat-card-change">Last 7 days</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Most Connected Clicks</span>
                        <span class="stat-card-icon">‚ö°</span>
                    </div>
                    <div class="stat-card-value">${connectedClicks || 0}</div>
                    <div class="stat-card-change">Last 7 days</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Avg Feedback Rating</span>
                        <span class="stat-card-icon">‚≠ê</span>
                    </div>
                    <div class="stat-card-value">${avgRating}</div>
                    <div class="stat-card-change">${feedbackData?.length || 0} reviews</div>
                </div>
            `;

            document.getElementById('stats-grid').innerHTML = statsHtml;
        }

        async function loadTopRecommendations(supabase) {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

            const { data, error } = await supabase
                .from('component_analytics')
                .select('clicked_resource_path')
                .in('component_type', ['similar_resources', 'most_connected'])
                .eq('user_action', 'click')
                .gte('timestamp', sevenDaysAgo)
                .not('clicked_resource_path', 'is', null);

            if (error) {
                console.error('Error loading recommendations:', error);
                return;
            }

            // Count clicks per resource
            const clickCounts = {};
            data.forEach(item => {
                clickCounts[item.clicked_resource_path] = (clickCounts[item.clicked_resource_path] || 0) + 1;
            });

            // Sort and take top 10
            const topResources = Object.entries(clickCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const html = topResources.length > 0
                ? `<ul class="top-resources-list">
                    ${topResources.map(([path, count]) => `
                        <li>
                            <span class="resource-name">${path}</span>
                            <span class="resource-stat">${count} clicks</span>
                        </li>
                    `).join('')}
                </ul>`
                : '<p style="text-align: center; color: #6b7280; padding: 2rem;">No data available yet. Start using the components to see insights!</p>';

            document.getElementById('top-recommendations').innerHTML = html;
        }

        async function loadRecentFeedback(supabase) {
            const { data, error } = await supabase
                .from('teacher_feedback')
                .select('*')
                .order('timestamp', { ascending: false })
                .limit(10);

            if (error) {
                console.error('Error loading feedback:', error);
                return;
            }

            const html = data && data.length > 0
                ? data.map(fb => `
                    <div class="feedback-item">
                        <div class="feedback-rating">${'‚≠ê'.repeat(fb.rating)}</div>
                        ${fb.comment ? `<div class="feedback-comment">"${fb.comment}"</div>` : ''}
                        <div class="feedback-meta">
                            ${fb.feedback_type} ‚Ä¢ ${fb.resource_path} ‚Ä¢ ${new Date(fb.timestamp).toLocaleDateString()}
                        </div>
                    </div>
                `).join('')
                : '<p style="text-align: center; color: #6b7280; padding: 2rem;">No feedback yet. Teachers will provide feedback as they use the platform!</p>';

            document.getElementById('recent-feedback').innerHTML = html;
        }

        async function loadComponentPerformance(supabase) {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

            const { data, error } = await supabase
                .from('component_analytics')
                .select('component_type, user_action')
                .gte('timestamp', sevenDaysAgo);

            if (error) {
                console.error('Error loading performance:', error);
                return;
            }

            // Calculate metrics per component
            const metrics = {};
            data.forEach(item => {
                if (!metrics[item.component_type]) {
                    metrics[item.component_type] = { loaded: 0, clicks: 0, hovers: 0 };
                }
                if (item.user_action === 'component_loaded') metrics[item.component_type].loaded++;
                if (item.user_action === 'click') metrics[item.component_type].clicks++;
                if (item.user_action === 'hover_sustained') metrics[item.component_type].hovers++;
            });

            const html = Object.keys(metrics).length > 0
                ? `<ul class="top-resources-list">
                    ${Object.entries(metrics).map(([component, stats]) => `
                        <li>
                            <span class="resource-name">${component}</span>
                            <span class="resource-stat">
                                ${stats.loaded} loads ‚Ä¢ ${stats.clicks} clicks ‚Ä¢ ${stats.hovers} hovers
                            </span>
                        </li>
                    `).join('')}
                </ul>`
                : '<p style="text-align: center; color: #6b7280; padding: 2rem;">No performance data yet!</p>';

            document.getElementById('component-performance').innerHTML = html;
        }

        // Initialize dashboard
        initDashboard();

        // Auto-refresh every 30 seconds
        setInterval(initDashboard, 30000);
    </script>
</body>
</html>

