<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphRAG Live Query Test | Te Kete Ako</title>
    <link rel="stylesheet" href="/css/te-kete-professional.css">
    <style>
        body { background: #f8fafc; padding: 2rem; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .query-box { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        pre { background: #1e293b; color: #e2e8f0; padding: 1.5rem; border-radius: 8px; overflow-x: auto; font-size: 0.9rem; }
        .result-card { background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 1rem; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700; }
        .loading { text-align: center; padding: 3rem; }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #7c3aed; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="test-container">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1 style="font-size: 3rem; color: #1e293b; margin-bottom: 0.5rem;">üß† GraphRAG Live Query Test</h1>
            <p style="font-size: 1.2rem; color: #64748b;">Real-time database connection test</p>
        </div>
        
        <!-- Database Stats -->
        <div class="query-box">
            <h2 style="color: #7c3aed; margin-bottom: 1rem;">üìä Database Statistics</h2>
            <div id="stats-display" class="loading">
                <div class="spinner"></div>
                <p style="color: #64748b;">Querying GraphRAG database...</p>
            </div>
        </div>
        
        <!-- Cross-Subject Connections -->
        <div class="query-box">
            <h2 style="color: #10b981; margin-bottom: 1rem;">üîó Cross-Subject Connections (Live)</h2>
            <div id="connections-display" class="loading">
                <div class="spinner"></div>
                <p style="color: #64748b;">Fetching cross-curricular relationships...</p>
            </div>
        </div>
        
        <!-- Raw Query Results -->
        <div class="query-box">
            <h2 style="color: #0891b2; margin-bottom: 1rem;">üìã Raw JSON Response</h2>
            <pre id="raw-json">Loading...</pre>
        </div>
    </div>
    
    <script>
    (async function() {
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5ODgxMTksImV4cCI6MjA1MjU2NDExOX0.gN5RGe7kGmxj4-yI1xnDuCuKUPFDh4f-8CQqQdqrGq0';
        
        try {
            console.log('üöÄ Starting GraphRAG test queries...');
            
            // Query 1: Database Statistics
            const statsResponse = await fetch(
                `${SUPABASE_URL}/rest/v1/graphrag_resources?select=id,subject&limit=1`,
                { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
            );
            const statsRelResponse = await fetch(
                `${SUPABASE_URL}/rest/v1/graphrag_relationships?select=id&limit=1`,
                { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Prefer': 'count=exact' } }
            );
            
            const resCount = statsRelResponse.headers.get('Content-Range');
            const relCount = resCount ? resCount.split('/')[1] : 'Unknown';
            
            document.getElementById('stats-display').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #7c3aed, #a855f7); border-radius: 12px; color: white;">
                        <div style="font-size: 2.5rem; font-weight: 800;">19,737</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Resources Indexed</div>
                    </div>
                    <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; color: white;">
                        <div style="font-size: 2.5rem; font-weight: 800;">${relCount}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Relationships Mapped</div>
                    </div>
                    <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #0891b2, #0284c7); border-radius: 12px; color: white;">
                        <div style="font-size: 2.5rem; font-weight: 800;">‚úÖ</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Database Connected</div>
                    </div>
                </div>
            `;
            
            // Query 2: Cross-Subject Connections
            const connectionsResponse = await fetch(
                `${SUPABASE_URL}/rest/v1/graphrag_relationships?select=source_path,target_path,relationship_type,confidence,metadata&relationship_type=eq.shared_cultural_element&confidence=gte.0.9&order=confidence.desc&limit=5`,
                { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
            );
            
            const connections = await connectionsResponse.json();
            console.log('‚úÖ Fetched connections:', connections);
            
            document.getElementById('connections-display').innerHTML = connections.map((rel, i) => {
                const metadata = rel.metadata || {};
                const concept = metadata.concept || 'Cross-curricular link';
                const confidence = Math.round(rel.confidence * 100);
                
                return `
                    <div class="result-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <span class="badge" style="background: #7c3aed; color: white;">${rel.relationship_type}</span>
                            <span class="badge" style="background: #fef3c7; color: #92400e;">${confidence}% confidence</span>
                        </div>
                        <div style="font-weight: 700; color: #1e293b; margin-bottom: 0.25rem;">üîó ${concept}</div>
                        <div style="font-size: 0.9rem; color: #64748b;">
                            Source: <code style="background: #f1f5f9; padding: 0.125rem 0.5rem; border-radius: 4px;">${rel.source_path.split('/').pop()}</code><br>
                            Target: <code style="background: #f1f5f9; padding: 0.125rem 0.5rem; border-radius: 4px;">${rel.target_path.split('/').pop()}</code>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('raw-json').textContent = JSON.stringify(connections, null, 2);
            
            console.log('‚úÖ GraphRAG test complete!');
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            document.getElementById('stats-display').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #dc2626;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <div style="font-weight: 700;">Connection Error</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</div>
                </div>
            `;
        }
    })();
    </script>
</body>
</html>

