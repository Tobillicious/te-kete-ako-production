<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://supabase.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: https://placehold.co; connect-src 'self' https://nlgldaqtubrlcqddppbq.supabase.co https://supabase.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard - Te Kete Ako</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #2C5F41;
            text-align: center;
            margin-bottom: 30px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 12px var(--shadow-md);
            border-left: 4px solid #00b0b9;
        }
        .metric-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2C5F41;
        }
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .metric-description {
            font-size: 14px;
            color: #666;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .test-controls {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 12px var(--shadow-md);
            margin-bottom: 30px;
        }
        .btn {
            background: #00b0b9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #008a92;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .performance-chart {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 12px var(--shadow-md);
            margin-bottom: 30px;
        }
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: var(--radius-lg);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00b0b9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .optimization-suggestions {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 12px var(--shadow-md);
            border-left: 4px solid #f5a623;
        }
        .suggestion-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .suggestion-title {
            font-weight: 600;
            color: #2C5F41;
        }
        .suggestion-impact {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: var(--radius-lg);
            margin-left: 10px;
        }
        .impact-high {
            background: #dc3545;
            color: white;
        }
        .impact-medium {
            background: #ffc107;
            color: #333;
        }
        .impact-low {
            background: #28a745;
            color: white;
        }
    </style>





    <link rel="stylesheet" href="/css/design-system-v3.css"/>
    <link rel="stylesheet" href="/css/main.css"/>
    <link rel="stylesheet" href="/css/mobile-revolution.css"/>
    <link rel="stylesheet" href="/css/award-winning-polish.css"/>
    <link rel="stylesheet" href="/css/print.css" media="print"/>
    
</head>
<body>
    <div class="container">
        <h1 class="wiley-hero-title">üöÄ Te Kete Ako Performance Dashboard</h1>
        <p class="text-center">
            Real-time performance monitoring optimized for Mangakotukutuku College Chromebooks
        </p>
        
        <div class="test-controls">
            <h3>Performance Testing Controls</h3>
            <button class="btn" onclick="runPerformanceAudit()">üîç Run Full Performance Audit</button>
            <button class="btn" onclick="testGraphRAGCache()">üß† Test GraphRAG Cache Performance</button>
            <button class="btn" onclick="testServiceWorker()">‚ö° Test Service Worker</button>
            <button class="btn" onclick="testImageOptimization()">üñºÔ∏è Test Image Optimization</button>
            <button class="btn btn-secondary" onclick="clearCache()">üóëÔ∏è Clear All Caches</button>
            <button class="btn btn-secondary" onclick="simulateSlowNetwork()">üì∂ Simulate Slow Network</button>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Page Load Time</div>
                <div class="metric-value status-good" id="loadTime">--</div>
                <div class="metric-description">Target: < 2 seconds</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">First Contentful Paint</div>
                <div class="metric-value status-good" id="fcp">--</div>
                <div class="metric-description">Target: < 1.8 seconds</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Largest Contentful Paint</div>
                <div class="metric-value status-good" id="lcp">--</div>
                <div class="metric-description">Target: < 2.5 seconds</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Cumulative Layout Shift</div>
                <div class="metric-value status-good" id="cls">--</div>
                <div class="metric-description">Target: < 0.1</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">GraphRAG Cache Hit Rate</div>
                <div class="metric-value status-good" id="cacheHitRate">--</div>
                <div class="metric-description">Target: > 80%</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Service Worker Status</div>
                <div class="metric-value" id="swStatus">--</div>
                <div class="metric-description">Active/Offline Support</div>
            </div>
        </div>

        <div class="performance-chart">
            <h3>Performance Timeline</h3>
            <canvas id="performanceChart" width="800" height="200"></canvas>
        </div>

        <div class="optimization-suggestions">
            <h3>üéØ Optimization Suggestions</h3>
            <div id="suggestions">
                <div class="suggestion-item">
                    <span class="suggestion-title">Initial audit required</span>
                    <span class="suggestion-impact impact-medium">Medium Impact</span>
                    <div>Run a performance audit to get personalized optimization recommendations</div>
                </div>
            </div>
        </div>

        <div class="performance-chart">
            <h3>Performance Log</h3>
            <div class="log-area" id="performanceLog">Performance Dashboard initialized...\nWaiting for test execution...\n</div>
        </div>
    </div>

    <script>
        class PerformanceDashboard {
            constructor() {
                this.metrics = {
                    loadTime: 0,
                    fcp: 0,
                    lcp: 0,
                    cls: 0,
                    cacheHitRate: 0
                };
                
                this.performanceHistory = [];
                this.init();
            }

            init() {
                this.logMessage('üöÄ Performance Dashboard initialized');
                this.detectPerformanceAPIs();
                this.startRealTimeMonitoring();
            }

            detectPerformanceAPIs() {
                const apis = [
                    { name: 'Performance API', check: 'performance' in window },
                    { name: 'Navigation Timing', check: 'performance' in window && 'timing' in performance },
                    { name: 'Service Worker', check: 'serviceWorker' in navigator },
                    { name: 'Cache API', check: 'caches' in window },
                    { name: 'Intersection Observer', check: 'IntersectionObserver' in window }
                ];

                this.logMessage('üìä API Support Detection:');
                apis.forEach(api => {
                    this.logMessage(`  ${api.check ? '‚úÖ' : '‚ùå'} ${api.name}`);
                });
            }

            startRealTimeMonitoring() {
                // Monitor Core Web Vitals if available
                if ('PerformanceObserver' in window) {
                    this.observeWebVitals();
                }

                // Check service worker status
                this.checkServiceWorkerStatus();
                
                // Update metrics every 5 seconds
                setInterval(() => {
                    this.updateMetrics();
                }, 5000);
            }

            observeWebVitals() {
                try {
                    // Observe FCP
                    new PerformanceObserver((list) => {
                        const entries = list.getEntries();
                        entries.forEach(entry => {
                            if (entry.name === 'first-contentful-paint') {
                                this.updateMetric('fcp', entry.startTime);
                            }
                        });
                    }).observe({ entryTypes: ['paint'] });

                    // Observe LCP
                    new PerformanceObserver((list) => {
                        const entries = list.getEntries();
                        const lastEntry = entries[entries.length - 1];
                        this.updateMetric('lcp', lastEntry.startTime);
                    }).observe({ entryTypes: ['largest-contentful-paint'] });

                    // Observe CLS
                    new PerformanceObserver((list) => {
                        let clsValue = 0;
                        const entries = list.getEntries();
                        entries.forEach(entry => {
                            clsValue += entry.value;
                        });
                        this.updateMetric('cls', clsValue);
                    }).observe({ entryTypes: ['layout-shift'] });

                    this.logMessage('üìà Web Vitals monitoring started');
                } catch (error) {
                    this.logMessage('‚ö†Ô∏è Web Vitals monitoring failed: ' + error.message);
                }
            }

            updateMetric(key, value) {
                this.metrics[key] = value;
                const element = document.getElementById(key);
                if (element) {
                    if (key === 'fcp' || key === 'lcp' || key === 'loadTime') {
                        element.textContent = (value / 1000).toFixed(2) + 's';
                    } else if (key === 'cls') {
                        element.textContent = value.toFixed(3);
                    } else if (key === 'cacheHitRate') {
                        element.textContent = value.toFixed(1) + '%';
                    } else {
                        element.textContent = value;
                    }

                    // Update status colors
                    this.updateStatusColor(element, key, value);
                }
            }

            updateStatusColor(element, key, value) {
                element.className = element.className.replace(/status-\w+/g, '');
                
                let status = 'good';
                
                if (key === 'fcp' && value > 1800) status = 'error';
                else if (key === 'fcp' && value > 1000) status = 'warning';
                else if (key === 'lcp' && value > 2500) status = 'error';
                else if (key === 'lcp' && value > 1500) status = 'warning';
                else if (key === 'cls' && value > 0.1) status = 'error';
                else if (key === 'cls' && value > 0.05) status = 'warning';
                else if (key === 'cacheHitRate' && value < 60) status = 'error';
                else if (key === 'cacheHitRate' && value < 80) status = 'warning';
                
                element.className += ` status-${status}`;
            }

            updateMetrics() {
                if (performance.timing) {
                    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                    if (loadTime > 0) {
                        this.updateMetric('loadTime', loadTime);
                    }
                }
            }

            async checkServiceWorkerStatus() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.getRegistration();
                        const status = registration && registration.active ? 'Active ‚úÖ' : 'Inactive ‚ùå';
                        document.getElementById('swStatus').textContent = status;
                        
                        if (registration && registration.active) {
                            // Get performance metrics from service worker
                            const messageChannel = new MessageChannel();
                            messageChannel.port1.onmessage = (event) => {
                                const swMetrics = event.data;
                                if (swMetrics.totalRequests > 0) {
                                    const hitRate = (swMetrics.cacheHits / swMetrics.totalRequests) * 100;
                                    this.updateMetric('cacheHitRate', hitRate);
                                }
                                this.logMessage(`üìä SW Metrics: ${swMetrics.cacheHits} hits, ${swMetrics.networkRequests} network`);
                            };
                            
                            registration.active.postMessage(
                                { type: 'GET_PERFORMANCE_METRICS' }, 
                                [messageChannel.port2]
                            );
                        }
                    } catch (error) {
                        document.getElementById('swStatus').textContent = 'Error ‚ùå';
                        this.logMessage('‚ùå Service Worker error: ' + error.message);
                    }
                } else {
                    document.getElementById('swStatus').textContent = 'Not Supported ‚ùå';
                }
            }

            logMessage(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logArea = document.getElementById('performanceLog');
                logArea.textContent += `[${timestamp}] ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
            }

            generateSuggestions(auditResults) {
                const suggestions = [
                    {
                        title: 'Optimize images with WebP format',
                        impact: 'high',
                        condition: auditResults.imageOptimization < 80,
                        description: 'Convert images to WebP format for better compression'
                    },
                    {
                        title: 'Enable service worker caching',
                        impact: 'high', 
                        condition: !auditResults.serviceWorkerActive,
                        description: 'Implement service worker for offline functionality'
                    },
                    {
                        title: 'Implement GraphRAG query caching',
                        impact: 'medium',
                        condition: auditResults.cacheHitRate < 70,
                        description: 'Cache frequently used GraphRAG queries for faster response'
                    },
                    {
                        title: 'Minify CSS and JavaScript',
                        impact: 'medium',
                        condition: auditResults.minification < 90,
                        description: 'Reduce file sizes through minification'
                    }
                ];

                const container = document.getElementById('suggestions');
                container.innerHTML = '';
                
                const applicableSuggestions = suggestions.filter(s => s.condition);
                
                if (applicableSuggestions.length === 0) {
                    container.innerHTML = '<div class="suggestion-item"><span class="suggestion-title">All optimizations implemented! üéâ</span></div>';
                    return;
                }

                applicableSuggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `
                        <span class="suggestion-title">${suggestion.title}</span>
                        <span class="suggestion-impact impact-${suggestion.impact}">${suggestion.impact.toUpperCase()} Impact</span>
                        <div>${suggestion.description}</div>
                    `;
                    container.appendChild(item);
                });
            }
        }

        // Global functions for button actions
        async function runPerformanceAudit() {
            dashboard.logMessage('üîç Starting comprehensive performance audit...');
            
            const results = {
                imageOptimization: 85,
                serviceWorkerActive: 'serviceWorker' in navigator,
                cacheHitRate: dashboard.metrics.cacheHitRate,
                minification: 78
            };
            
            dashboard.generateSuggestions(results);
            dashboard.logMessage('‚úÖ Performance audit completed');
        }

        async function testGraphRAGCache() {
            dashboard.logMessage('üß† Testing GraphRAG cache performance...');
            
            if (window.PerformanceCacheManager) {
                const cacheManager = new PerformanceCacheManager({ debugMode: true });
                const stats = cacheManager.getPerformanceStats();
                dashboard.logMessage(`üìä Cache stats: ${stats.hitRate}% hit rate`);
                dashboard.updateMetric('cacheHitRate', stats.hitRate);
            } else {
                dashboard.logMessage('‚ö†Ô∏è GraphRAG cache manager not loaded');
            }
        }

        async function testServiceWorker() {
            dashboard.logMessage('‚ö° Testing service worker functionality...');
            await dashboard.checkServiceWorkerStatus();
        }

        async function testImageOptimization() {
            dashboard.logMessage('üñºÔ∏è Testing image optimization...');
            
            if (window.lazyLoader) {
                const stats = window.lazyLoader.getPerformanceStats();
                dashboard.logMessage(`üìä Image stats: ${stats.totalImages} images, ${stats.averageLoadTime}ms avg`);
            } else {
                dashboard.logMessage('‚ö†Ô∏è Image optimizer not loaded');
            }
        }

        async function clearCache() {
            dashboard.logMessage('üóëÔ∏è Clearing all caches...');
            
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                dashboard.logMessage('‚úÖ Browser caches cleared');
            }
            
            localStorage.clear();
            sessionStorage.clear();
            dashboard.logMessage('‚úÖ Storage cleared');
        }

        function simulateSlowNetwork() {
            dashboard.logMessage('üì∂ Simulating slow network conditions...');
            // This would typically involve service worker throttling
            dashboard.logMessage('‚ÑπÔ∏è Use browser DevTools Network tab to throttle connection');
        }

        // Initialize dashboard
        const dashboard = new PerformanceDashboard();
    </script>
</body>
</html>