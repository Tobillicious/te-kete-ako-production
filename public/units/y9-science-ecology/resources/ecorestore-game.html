<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EcoRestore Simulation | Te Kete Ako</title>
      <link rel="stylesheet" href="/css/te-kete-professional.css">
<link rel="stylesheet" href="../../../css/main.css" />
  <style>
    body{background:#f0f4f0;font-family:'Lato',sans-serif}
    .game-wrapper{max-width:1200px;margin:0 auto;padding:1rem}
    .game-header{background:linear-gradient(135deg,#2c5f41,#40826d);color:#fff;padding:1.5rem;border-radius:12px;text-align:center}
    .game-board{display:grid;grid-template-columns:250px 1fr 280px;gap:1rem;margin:1rem 0}
    @media(max-width:1000px){.game-board{grid-template-columns:1fr}}
    .panel{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .stat{display:flex;justify-content:space-between;padding:.5rem;border-bottom:1px solid #e1e5e9}
    .stat:last-child{border:0}
    .stat-val{font-weight:700;color:var(--color-secondary)}
    .ecosystem-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:.5rem;min-height:300px;background:#f8faf8;border-radius:8px;padding:.75rem}
    .species-tile{background:#fff;border:2px solid #e1e5e9;border-radius:8px;padding:.5rem;text-align:center;font-size:1.5rem;cursor:pointer}
    .species-tile.plant{border-color:#4ade80}
    .species-tile.bird{border-color:#60a5fa}
    .species-tile.predator{border-color:#ef4444}
    .action-btn{background:var(--color-secondary);color:#fff;border:none;border-radius:8px;padding:.75rem 1rem;margin:.25rem;cursor:pointer;font-weight:600}
    .action-btn:disabled{opacity:.4;cursor:not-allowed}
    .action-btn:hover:not(:disabled){background:var(--color-primary)}
    .card{background:#fff;border:1px solid #e1e5e9;border-radius:8px;padding:.75rem;margin:.5rem 0;font-size:.9rem}
    .card.event{border-left:4px solid #f59e0b}
    .card.species{border-left:4px solid #10b981}
    .log{background:#f8faf8;border-radius:8px;padding:.75rem;max-height:200px;overflow-y:auto;font-size:.85rem}
    .log-item{padding:.25rem 0;border-bottom:1px solid #e1e5e9}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:12px;padding:2rem;max-width:500px;margin:1rem}
  </style>
</head>
<body>
  <div class="game-wrapper">
    <header class="game-header">
      <h1 style="margin:0">ğŸŒ¿ EcoRestore: Kaitiaki Challenge</h1>
      <p style="margin:.5rem 0 0;opacity:.9">Restore the ecosystem through wise kaitiakitanga</p>
    </header>

    <div class="game-board">
      <!-- Left: Resources & Actions -->
      <aside class="panel">
        <h3 style="margin-top:0">Resources</h3>
        <div class="stat"><span>ğŸ’° Budget</span><span class="stat-val" id="budget">$50,000</span></div>
        <div class="stat"><span>ğŸ‘¥ Volunteers</span><span class="stat-val" id="volunteers">10</span></div>
        <div class="stat"><span>ğŸ† Biodiversity</span><span class="stat-val" id="biodiversity">0</span></div>
        <div class="stat"><span>ğŸ¯ Round</span><span class="stat-val" id="round">1/15</span></div>
        <hr style="margin:1rem 0">
        <h4>Actions (3 per turn)</h4>
        <div id="actions-left" style="text-align:center;font-size:1.2rem;font-weight:700;color:var(--color-secondary);margin:.5rem 0">3 left</div>
        <button class="action-btn" onclick="game.plantNative()">ğŸŒ³ Plant Native ($10K, 5ğŸ‘¥)</button>
        <button class="action-btn" onclick="game.setTrap()">ğŸª¤ Set Trap ($5K, 3ğŸ‘¥)</button>
        <button class="action-btn" onclick="game.buildFence()">ğŸš§ Build Fence ($30K)</button>
        <button class="action-btn" onclick="game.introduceSpecies()">ğŸ¦œ Add Species ($15K)</button>
        <button class="action-btn" onclick="game.communityEngage()">ğŸ¤ Engage Community ($8K, 4ğŸ‘¥)</button>
        <button class="action-btn" onclick="game.endTurn()" style="background:#f59e0b;margin-top:1rem">â–¶ï¸ End Turn</button>
      </aside>

      <!-- Center: Ecosystem -->
      <main class="panel">
        <h3 style="margin-top:0">Your Ecosystem</h3>
        <div class="ecosystem-grid" id="ecosystem"></div>
        <div style="margin-top:1rem;font-size:.85rem;color:#6b7280">
          <span style="color:#4ade80">â– </span> Plants
          <span style="color:#60a5fa;margin-left:1rem">â– </span> Birds
          <span style="color:#ef4444;margin-left:1rem">â– </span> Predators
        </div>
      </main>

      <!-- Right: Cards & Events -->
      <aside class="panel">
        <h3 style="margin-top:0">Current Status</h3>
        <div id="status-panel">
          <div class="card" id="current-event" style="display:none"></div>
          <div class="card" id="last-action"></div>
        </div>
        <h4 style="margin-top:1rem">Game Log</h4>
        <div class="log" id="game-log"></div>
      </aside>
    </div>
  </div>

  <!-- Win Modal -->
  <div class="modal" id="win-modal">
    <div class="modal-content">
      <h2 style="text-align:center">ğŸ‰ Victory!</h2>
      <p id="win-message" style="text-align:center"></p>
      <button class="action-btn" onclick="game.restart()" style="width:100%">Play Again</button>
    </div>
  </div>

  <script>
    const game = {
      budget: 50000,
      volunteers: 10,
      biodiversity: 0,
      round: 1,
      actionsLeft: 3,
      hasFence: false,
      ecosystem: [],
      communityTokens: 0,
      
      species: {
        plants: [{n:'Rimu',ico:'ğŸŒ²',pts:5},{n:'Harakeke',ico:'ğŸŒ¿',pts:5},{n:'KÅwhai',ico:'ğŸŒ¼',pts:5},{n:'Kahikatea',ico:'ğŸŒ³',pts:5}],
        birds: [{n:'KererÅ«',ico:'ğŸ¦œ',pts:10,req:'plant'},{n:'TÅ«Ä«',ico:'ğŸ¦',pts:10,req:'plant'},{n:'KÄkÄpÅ',ico:'ğŸ¦‰',pts:20,req:'fence'},{n:'Kiwi',ico:'ğŸ¥',pts:15,req:'fence'}],
        predators: [{n:'Rat',ico:'ğŸ€',dmg:5},{n:'Stoat',ico:'ğŸ¦¡',dmg:5},{n:'Possum',ico:'ğŸ¦',dmg:5}]
      },
      
      events: [
        {txt:'ğŸŒ§ï¸ La NiÃ±a: Great growing! All plants +5pts this round',effect:()=>{game.ecosystem.filter(s=>s.type==='plant').forEach(s=>s.pts+=5);game.log('Plants thriving!')}},
        {txt:'ğŸ’° Lottery Grant: +$15K for all',effect:()=>{game.budget+=15000;game.log('Grant received!')}},
        {txt:'ğŸ“ School Visit: +5 volunteers',effect:()=>{game.volunteers+=5;game.log('Volunteers join!')}},
        {txt:'ğŸ“° Media Feature: Community token holder gets +$20K',effect:()=>{if(game.communityTokens>0){game.budget+=20000;game.log('Media funding!')}}},
        {txt:'ğŸ¦… Bird Discovery: If 5+ plants & no predators, get rare bird (25pts)',effect:()=>{const plants=game.ecosystem.filter(s=>s.type==='plant').length,preds=game.ecosystem.filter(s=>s.type==='predator').length;if(plants>=5&&preds===0){game.ecosystem.push({n:'TakahÄ“',ico:'ğŸ¦š',pts:25,type:'bird'});game.log('Rare TakahÄ“ discovered!')}}},
      ],
      
      init(){
        this.render();
        this.drawEvent();
      },
      
      render(){
        document.getElementById('budget').textContent='$'+(this.budget/1000)+'K';
        document.getElementById('volunteers').textContent=this.volunteers;
        document.getElementById('biodiversity').textContent=this.biodiversity;
        document.getElementById('round').textContent=this.round+'/15';
        document.getElementById('actions-left').textContent=this.actionsLeft+' left';
        
        const eco=document.getElementById('ecosystem');
        eco.innerHTML=this.ecosystem.map(s=>`<div class="species-tile ${s.type}" title="${s.n}">${s.ico}</div>`).join('');
        
        this.updateActionButtons();
        this.calcBiodiversity();
      },
      
      updateActionButtons(){
        const btns=document.querySelectorAll('.action-btn');
        btns.forEach(b=>{
          if(b.textContent.includes('End Turn'))return;
          b.disabled=this.actionsLeft<=0;
        });
      },
      
      canAfford(cost,vol){
        return this.budget>=cost&&this.volunteers>=vol;
      },
      
      spend(cost,vol){
        if(!this.canAfford(cost,vol))return false;
        this.budget-=cost;
        this.volunteers-=vol;
        this.actionsLeft--;
        return true;
      },
      
      plantNative(){
        if(!this.spend(10000,5))return this.log('âŒ Not enough resources!');
        const sp=this.species.plants[Math.floor(Math.random()*this.species.plants.length)];
        this.ecosystem.push({...sp,type:'plant'});
        this.log(`ğŸŒ± Planted ${sp.n}`);
        this.render();
      },
      
      setTrap(){
        if(!this.spend(5000,3))return this.log('âŒ Not enough resources!');
        const pred=this.ecosystem.findIndex(s=>s.type==='predator');
        if(pred>=0){
          const removed=this.ecosystem.splice(pred,1)[0];
          this.log(`ğŸª¤ Removed ${removed.n}`);
        }else{
          this.log('ğŸª¤ Trap set (no predators yet)');
        }
        this.render();
      },
      
      buildFence(){
        if(this.hasFence)return this.log('âŒ Fence already built!');
        if(!this.spend(30000,0))return this.log('âŒ Not enough budget!');
        this.hasFence=true;
        this.log('ğŸš§ Fence complete! Predators blocked.');
        this.render();
      },
      
      introduceSpecies(){
        if(!this.spend(15000,0))return this.log('âŒ Not enough budget!');
        const plants=this.ecosystem.filter(s=>s.type==='plant').length;
        const eligible=this.species.birds.filter(b=>b.req==='plant'&&plants>=3||b.req==='fence'&&this.hasFence||!b.req);
        if(eligible.length===0)return this.log('âŒ Habitat not ready for birds!');
        const sp=eligible[Math.floor(Math.random()*eligible.length)];
        this.ecosystem.push({...sp,type:'bird'});
        this.log(`ğŸ¦œ ${sp.n} introduced!`);
        this.render();
      },
      
      communityEngage(){
        if(!this.spend(8000,4))return this.log('âŒ Not enough resources!');
        this.communityTokens++;
        this.log('ğŸ¤ Community engagement +1');
        this.render();
      },
      
      drawEvent(){
        const ev=this.events[Math.floor(Math.random()*this.events.length)];
        document.getElementById('current-event').innerHTML=`<strong>Event:</strong> ${ev.txt}`;
        document.getElementById('current-event').style.display='block';
        document.getElementById('current-event').classList.add('event');
        ev.effect();
        this.render();
      },
      
      predatorPhase(){
        if(!this.hasFence){
          const pred=this.species.predators[Math.floor(Math.random()*this.species.predators.length)];
          this.ecosystem.push({...pred,type:'predator'});
          this.log(`âš ï¸ ${pred.n} appeared!`);
        }
        
        this.ecosystem.filter(s=>s.type==='predator').forEach(p=>{
          const victim=this.ecosystem.findIndex(s=>s.type==='plant'||s.type==='bird');
          if(victim>=0){
            const removed=this.ecosystem.splice(victim,1)[0];
            this.log(`ğŸ’€ ${p.n} ate ${removed.n}`);
          }else{
            this.biodiversity=Math.max(0,this.biodiversity-p.dmg);
          }
        });
      },
      
      income(){
        this.budget+=20000+this.communityTokens*5000;
        this.volunteers+=this.communityTokens*2;
        this.log(`ğŸ’µ Income: +$${20+this.communityTokens*5}K, +${this.communityTokens*2} volunteers`);
      },
      
      calcBiodiversity(){
        let pts=0;
        const plants=this.ecosystem.filter(s=>s.type==='plant');
        const birds=this.ecosystem.filter(s=>s.type==='bird');
        const preds=this.ecosystem.filter(s=>s.type==='predator');
        
        plants.forEach(p=>pts+=p.pts||5);
        birds.forEach(b=>{
          pts+=b.pts||10;
          if(plants.length>=5)pts+=5; // habitat bonus
        });
        preds.forEach(p=>pts-=p.dmg||5);
        pts+=this.communityTokens*5;
        
        this.biodiversity=Math.max(0,pts);
        
        if(this.biodiversity>=100){
          this.win('Reached 100 biodiversity points!');
        }
        if(plants.length>=5&&birds.length>=3&&preds.length===0&&this.communityTokens>=10){
          this.win('Perfect Ecosystem achieved!');
        }
      },
      
      endTurn(){
        this.predatorPhase();
        this.calcBiodiversity();
        this.round++;
        if(this.round>15){
          this.win(`Game complete! Final score: ${this.biodiversity} points`);
          return;
        }
        this.actionsLeft=3;
        this.income();
        this.drawEvent();
        this.render();
      },
      
      win(msg){
        document.getElementById('win-message').textContent=msg+' Biodiversity: '+this.biodiversity+' points.';
        document.getElementById('win-modal').classList.add('show');
      },
      
      restart(){
        this.budget=50000;
        this.volunteers=10;
        this.biodiversity=0;
        this.round=1;
        this.actionsLeft=3;
        this.hasFence=false;
        this.ecosystem=[];
        this.communityTokens=0;
        document.getElementById('game-log').innerHTML='';
        document.getElementById('win-modal').classList.remove('show');
        this.init();
      },
      
      log(msg){
        const log=document.getElementById('game-log');
        const item=document.createElement('div');
        item.className='log-item';
        item.textContent=`R${this.round}: ${msg}`;
        log.insertBefore(item,log.firstChild);
      }
    };
    
    window.addEventListener('DOMContentLoaded',()=>game.init());
  </script>

  <script src="../../../vendor/supabase.min.js" defer></script>
  <script src="../../../js/env-config.js" defer></script>
  <script src="../../../js/supabase-client.js" defer></script>
  <script src="../../../js/auth-ui.js" defer></script>
</body>
</html>
