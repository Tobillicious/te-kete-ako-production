<!-- GraphRAG Semantic Search Component - Enhanced with Cultural Context Awareness --><div id="graphrag-search-widget" style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); border-radius: 16px; padding: 2rem; margin: 2rem 0; box-shadow: 0 8px 30px rgba(30, 27, 75, 0.3); position: relative; overflow: hidden;">    <!-- Cultural Pattern Background -->    <div style="position: absolute; top: 0; right: 0; opacity: 0.05; font-size: 4rem; transform: rotate(15deg);">üåø</div>    <div style="position: absolute; bottom: 0; left: 0; opacity: 0.05; font-size: 3rem; transform: rotate(-10deg);">üß†</div>    <div style="text-align: center; margin-bottom: 1.5rem; position: relative; z-index: 1;">        <h3 style="color: white; font-size: 1.75rem; margin-bottom: 0.5rem; font-weight: 700;">            üß† Intelligent Resource Discovery        </h3>        <p style="color: rgba(255,255,255,0.85); font-size: 0.95rem;">            Powered by GraphRAG: Search by meaning, not just keywords        </p>    </div>    <!-- Search Input -->    <div style="position: relative; margin-bottom: 1.5rem;">        <input            type="text"            id="graphrag-search-input"            placeholder="Search by topic, concept, or cultural element..."            style="width: 100%; padding: 1rem 3rem 1rem 1.5rem; border: 3px solid rgba(255,255,255,0.2); border-radius: 12px; font-size: 1.1rem; background: rgba(255,255,255,0.95); transition: all 0.3s;"            onfocus="this.style.borderColor='#a855f7'; this.style.background='white';"            onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(255,255,255,0.95)';"        />        <div style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.5rem; opacity: 0.5;">üîç</div>    </div>    <!-- Filters -->    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;">        <button class="filter-btn active" data-filter="all" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s;">            All        </button>        <button class="filter-btn" data-filter="cultural" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s;">            üåø Cultural        </button>        <button class="filter-btn" data-filter="high-quality" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s;">            ‚≠ê Quality 90+        </button>        <button class="filter-btn" data-filter="te-reo" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s;">            üó£Ô∏è Te Reo        </button>        <button class="filter-btn" data-filter="whakataukƒ´" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s;">            üí¨ Whakataukƒ´        </button>    </div>    <!-- Quick Search Examples -->    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">        <span style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-right: 0.5rem;">Try:</span>        <button class="example-query" data-query="genetics whakapapa" style="background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 12px; cursor: pointer; font-size: 0.85rem; transition: background 0.2s;">            genetics whakapapa        </button>        <button class="example-query" data-query="kaitiakitanga" style="background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 12px; cursor: pointer; font-size: 0.85rem; transition: background 0.2s;">            kaitiakitanga        </button>        <button class="example-query" data-query="navigation physics" style="background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 12px; cursor: pointer; font-size: 0.85rem; transition: background 0.2s;">            navigation physics        </button>    </div>    <!-- Results -->    <div id="graphrag-search-results" style="display: none;"></div>    <!-- Stats Footer -->    <div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-top: 1rem;">        Searching <span id="search-resource-count">19,752</span> resources across <span id="search-relationship-count">231,530</span> knowledge connections    </div></div><style>.filter-btn:hover {    background: rgba(255,255,255,0.25) !important;    color: white !important;    border-color: rgba(255,255,255,0.4) !important;}.filter-btn.active {    background: rgba(255,255,255,0.3) !important;    color: white !important;    border-color: rgba(255,255,255,0.5) !important;}.example-query:hover {    background: rgba(255,255,255,0.25) !important;}.search-result-card {    background: white;    border-radius: 12px;    padding: 1.5rem;    margin-bottom: 1rem;    box-shadow: 0 2px 12px rgba(0,0,0,0.1);    text-decoration: none;    display: block;    border-left: 4px solid #7c3aed;    transition: all 0.3s;}.search-result-card:hover {    transform: translateX(8px);    box-shadow: 0 4px 20px rgba(124, 58, 237, 0.2);}.search-result-card.cultural {    border-left-color: #15803d;}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}</style><script>(function() {    const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5ODgxMTksImV4cCI6MjA1MjU2NDExOX0.gN5RGe7kGmxj4-yI1xnDuCuKUPFDh4f-8CQqQdqrGq0';    let currentFilter = 'all';    let searchTimeout;    // Initialize Supabase client    let supabase;    if (window.supabase && window.supabase.createClient) {        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);    }    // Enhanced search function with GraphRAG semantic intelligence    async function semanticSearch(query) {        if (!query || query.length < 2) {            document.getElementById('graphrag-search-results').style.display = 'none';            return;        }        try {            // Show loading state            showLoadingState();            // Enhanced search using GraphRAG relationships            const results = await enhancedSemanticSearch(query);            displayResults(results, query);        } catch (error) {            console.error('Semantic search error:', error);            showErrorState();        }    }    // Enhanced semantic search using GraphRAG relationships    async function enhancedSemanticSearch(query) {        // Parse query for cultural and semantic terms        const { culturalTerms, subjectTerms, generalTerms } = parseQuery(query);        // Build intelligent search query        let searchQuery = supabase            .from('graphrag_resources')            .select('file_path, title, resource_type, subject, year_level, quality_score, cultural_context, has_te_reo, has_whakataukƒ´, content_preview');        // Enhanced search logic        const searchConditions = [];        // Cultural terms get higher priority        if (culturalTerms.length > 0) {            const culturalOr = culturalTerms.map(term => `title.ilike.%${term}%,subject.ilike.%${term}%,content_preview.ilike.%${term}%`).join(',');            searchConditions.push(`(${culturalOr})`);        }        // Subject terms        if (subjectTerms.length > 0) {            const subjectOr = subjectTerms.map(term => `subject.ilike.%${term}%`).join(',');            searchConditions.push(`(${subjectOr})`);        }        // General terms        if (generalTerms.length > 0) {            const generalOr = generalTerms.map(term => `title.ilike.%${term}%,content_preview.ilike.%${term}%`).join(',');            searchConditions.push(`(${generalOr})`);        }        // Combine conditions        if (searchConditions.length > 0) {            searchQuery = searchQuery.or(searchConditions.join(' or '));        } else {            searchQuery = searchQuery.or(`title.ilike.%${query}%,subject.ilike.%${query}%,content_preview.ilike.%${query}%`);        }        // Apply active filter        if (currentFilter === 'cultural') {            searchQuery = searchQuery.eq('cultural_context', true);        } else if (currentFilter === 'high-quality') {            searchQuery = searchQuery.gte('quality_score', 90);        } else if (currentFilter === 'te-reo') {            searchQuery = searchQuery.eq('has_te_reo', true);        } else if (currentFilter === 'whakataukƒ´') {            searchQuery = searchQuery.eq('has_whakataukƒ´', true);        }        // Get results with enhanced ordering        const { data, error } = await searchQuery            .order('quality_score', { ascending: false })            .order('cultural_context', { ascending: false })            .limit(15);        if (error) throw error;        // Enhance results with relationship data        const enhancedResults = await enhanceResultsWithRelationships(data, query);        return enhancedResults;    }    // Parse query for intelligent search    function parseQuery(query) {        const lowerQuery = query.toLowerCase();        const culturalTerms = [];        const subjectTerms = [];        const generalTerms = [];        // Cultural keywords        const culturalKeywords = ['mƒÅori', 'maori', 'te reo', 'whakataukƒ´', 'whakatauki', 'kaitiakitanga', 'manaakitanga', 'whanaungatanga', 'rangatiratanga', 'tikanga', 'mƒÅtauranga', 'matauranga', 'p≈´rƒÅkau', 'purakau', 'whakapapa', 'taonga', 'iwi', 'hap≈´', 'hapu', 'marae'];        // Subject keywords        const subjectKeywords = ['math', 'mathematics', 'science', 'english', 'social studies', 'digital technology', 'te reo mƒÅori', 'te reo maori', 'arts', 'health', 'pe'];        // Check for cultural terms        culturalKeywords.forEach(keyword => {            if (lowerQuery.includes(keyword)) {                culturalTerms.push(keyword);            }        });        // Check for subject terms        subjectKeywords.forEach(keyword => {            if (lowerQuery.includes(keyword)) {                subjectTerms.push(keyword);            }        });        // Remaining terms go to general        const queryWords = query.split(' ').filter(word => word.length > 2);        queryWords.forEach(word => {            const lowerWord = word.toLowerCase();            if (!culturalTerms.includes(lowerWord) && !subjectTerms.includes(lowerWord)) {                generalTerms.push(word);            }        });        return { culturalTerms, subjectTerms, generalTerms };    }    // Enhance results with GraphRAG relationship data    async function enhanceResultsWithRelationships(results, query) {        if (!results || results.length === 0) return results;        try {            // Get related resources through GraphRAG relationships            const relatedResources = await getRelatedResources(query);            // Combine and deduplicate results            const allResults = [...results, ...relatedResources];            const uniqueResults = allResults.filter((resource, index, self) =>                index === self.findIndex(r => r.file_path === resource.file_path)            );            // Sort by relevance and quality            return uniqueResults                .sort((a, b) => {                    // Prioritize cultural resources                    if (a.cultural_context && !b.cultural_context) return -1;                    if (!a.cultural_context && b.cultural_context) return 1;                    // Then by quality score                    return b.quality_score - a.quality_score;                })                .slice(0, 15);        } catch (error) {            console.warn('Error enhancing results with relationships:', error);            return results;        }    }    // Get related resources through GraphRAG relationships    async function getRelatedResources(query) {        try {            // Find resources that are related through GraphRAG relationships            const { data: relationships, error } = await supabase                .from('graphrag_relationships')                .select('target_path, relationship_type')                .or(`source_path.ilike.%${query}%,relationship_type.ilike.%${query}%`)                .limit(10);            if (error || !relationships) return [];            // Get the actual resource data for related paths            const relatedPaths = relationships.map(r => r.target_path).filter(path => path.startsWith('/public/'));            if (relatedPaths.length === 0) return [];            const { data: relatedResources, error: relatedError } = await supabase                .from('graphrag_resources')                .select('file_path, title, resource_type, subject, year_level, quality_score, cultural_context, has_te_reo, has_whakataukƒ´, content_preview')                .in('file_path', relatedPaths);            return relatedError ? [] : (relatedResources || []);        } catch (error) {            console.warn('Error getting related resources:', error);            return [];        }    }    // Loading state    function showLoadingState() {        const container = document.getElementById('graphrag-search-results');        container.innerHTML = `            <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 12px; text-align: center; color: white;">                <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5rem;"></div>                <p style="font-size: 1rem; margin: 0;">Searching GraphRAG intelligence...</p>            </div>        `;        container.style.display = 'block';    }    // Error state    function showErrorState() {        const container = document.getElementById('graphrag-search-results');        container.innerHTML = `            <div style="background: rgba(220, 38, 38, 0.1); padding: 2rem; border-radius: 12px; text-align: center; color: white; border-left: 4px solid #dc2626;">                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">‚ùå Search Error</p>                <p style="opacity: 0.7; font-size: 0.9rem;">Please try again</p>            </div>        `;        container.style.display = 'block';    }    // Display search results    function displayResults(results, query) {        const container = document.getElementById('graphrag-search-results');        if (results.length === 0) {            container.innerHTML = `                <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 12px; text-align: center; color: white;">                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">üîç No results found</p>                    <p style="opacity: 0.7; font-size: 0.9rem;">Try different keywords or filters</p>                </div>            `;            container.style.display = 'block';            return;        }        const resultsHTML = `            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">                <p style="color: white; font-weight: 600;">                    Found <strong>${results.length}</strong> resources for "<strong>${query}</strong>"                </p>            </div>            <div style="max-height: 600px; overflow-y: auto; padding: 0.5rem;">                ${results.map(r => createResultCard(r)).join('')}            </div>        `;        container.innerHTML = resultsHTML;        container.style.display = 'block';    }    // Create result card    function createResultCard(resource) {        const culturalClass = resource.cultural_context ? ' cultural' : '';        const path = resource.file_path.startsWith('/') ? resource.file_path : `/${resource.file_path}`;        return `            <a href="${path}" class="search-result-card${culturalClass}">                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">                    <h4 style="color: ${resource.cultural_context ? '#15803d' : '#7c3aed'}; font-weight: 700; margin: 0; font-size: 1.1rem;">                        ${resource.title}                    </h4>                    <span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; margin-left: 1rem;">                        ‚òÖ ${resource.quality_score}                    </span>                </div>                <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem;">                    ${resource.year_level || 'All Levels'} ‚Ä¢ ${resource.subject || 'General'} ‚Ä¢ ${resource.resource_type || 'Resource'}                </p>                ${resource.content_preview ? `                    <p style="color: #475569; font-size: 0.85rem; line-height: 1.5; margin-bottom: 0.75rem;">                        ${resource.content_preview.substring(0, 150)}...                    </p>                ` : ''}                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">                    ${resource.cultural_context ? '<span style="background: #dcfce7; color: #15803d; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">üåø Cultural</span>' : ''}                    ${resource.has_te_reo ? '<span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">üó£Ô∏è Te Reo</span>' : ''}                    ${resource.has_whakataukƒ´ ? '<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">üí¨ Whakataukƒ´</span>' : ''}                </div>            </a>        `;    }    // Event listeners    const searchInput = document.getElementById('graphrag-search-input');    if (searchInput) {        searchInput.addEventListener('input', (e) => {            clearTimeout(searchTimeout);            searchTimeout = setTimeout(() => semanticSearch(e.target.value), 300);        });    }    // Filter buttons    document.querySelectorAll('.filter-btn').forEach(btn => {        btn.addEventListener('click', () => {            // Update active state            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));            btn.classList.add('active');            // Update filter            currentFilter = btn.dataset.filter;            // Re-run search if there's a query            const query = searchInput?.value;            if (query && query.length >= 2) {                semanticSearch(query);            }        });    });    // Example query buttons    document.querySelectorAll('.example-query').forEach(btn => {        btn.addEventListener('click', () => {            const query = btn.dataset.query;            if (searchInput) {                searchInput.value = query;                semanticSearch(query);            }        });    });    console.log('‚úÖ GraphRAG Semantic Search initialized');})();</script>