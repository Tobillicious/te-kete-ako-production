<!-- GraphRAG Knowledge Graph Component --><!-- Visualizes resource connections using D3.js force-directed graph --><div id="graphrag-knowledge-graph-container" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); rounded-2xl  p-8  margin: 2rem 0;">    <div style="flex  justify-content: space-between; align-items: center; mb-6 ">        <h3 style="text-2xl  color: #0c4a6e; m-0 ">            üß† Knowledge Graph Connections        </h3>        <div style="flex  gap: 1rem; align-items: center;">            <div style="flex  gap: 0.5rem; align-items: center;">                <div style="width: 12px; height: 12px; background: #0891b2; border-radius: 50%;"></div>                <span style="font-size: 0.85rem; color: #666;">Science</span>            </div>            <div style="flex  gap: 0.5rem; align-items: center;">                <div style="width: 12px; height: 12px; background: #0284c7; border-radius: 50%;"></div>                <span style="font-size: 0.85rem; color: #666;">Math</span>            </div>            <div style="flex  gap: 0.5rem; align-items: center;">                <div style="width: 12px; height: 12px; background: #dc2626; border-radius: 50%;"></div>                <span style="font-size: 0.85rem; color: #666;">English</span>            </div>            <div style="flex  gap: 0.5rem; align-items: center;">                <div style="width: 12px; height: 12px; background: #059669; border-radius: 50%;"></div>                <span style="font-size: 0.85rem; color: #666;">Social Studies</span>            </div>        </div>    </div>    <div id="graphrag-viz" style="width: 100%; height: 600px; background: white; rounded-xl  border: 2px solid #bae6fd; position: relative; overflow: hidden;">        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-center ">            <div style="border: 4px solid #7c3aed; border-top: 4px solid #a855f7; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; m-0  auto 1rem;"></div>            <p style="color: #666;">Loading knowledge graph...</p>        </div>    </div>    <div id="graph-controls" style="margin-top: 1.5rem; flex  gap: 1rem; flex-wrap: wrap; align-items: center;">        <button onclick="graphZoomIn()" class="bg-white$1">            üîç Zoom In        </button>        <button onclick="graphZoomOut()" class="bg-white$1">            üîé Zoom Out        </button>        <button onclick="graphReset()" class="bg-white$1">            üîÑ Reset View        </button>        <select id="graph-filter" onchange="filterGraph(this.value)" class="bg-white$1">            <option value="all">All Connections</option>            <option value="cross_curricular">Cross-Curricular</option>            <option value="cultural">Cultural</option>            <option value="prerequisite">Prerequisites</option>        </select>        <div id="graph-stats" style="margin-left: auto; background: white; px-4 py-2  rounded-lg  text-sm  color: #666;">            <strong>Nodes:</strong> <span id="node-count">0</span> |            <strong>Links:</strong> <span id="link-count">0</span>        </div>    </div></div><style>@keyframes spin {    0% { transform: rotate(0deg); }    100% { transform: rotate(360deg); }}.node {    cursor: pointer;    transition: all 0.2s;}.node:hover {    filter: brightness(1.2);}.link {    stroke: #999;    stroke-opacity: 0.6;    transition: all 0.2s;}.link:hover {    stroke-opacity: 1;    stroke-width: 3px;}.node-label {    font-size: 12px;    pointer-events: none;    text-anchor: middle;    font-semibold     fill: #333;    text-shadow: 1px 1px 2px white, -1px -1px 2px white;}</style><script src="https://d3js.org/d3.v7.min.js"></script><script>(function() {    const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';    const subjectColors = {        'Science': '#0891b2',        'Mathematics': '#0284c7',        'English': '#dc2626',        'Social Studies': '#059669',        'History': '#7c3aed',        'Digital Technologies': '#10b981',        'default': '#6b7280'    };    let svg, simulation, nodesData, linksData, nodeElements, linkElements, labelElements;    let transform = d3.zoomIdentity;    async function loadGraph() {        try {            console.log('üìä Loading knowledge graph data...');            // Fetch relationships            const relResponse = await fetch(                `${SUPABASE_URL}/rest/v1/graphrag_relationships?select=source_path,target_path,relationship_type,confidence&confidence=gte.0.80&limit=100`,                {                    headers: {                        'apikey': SUPABASE_KEY,                        'Authorization': `Bearer ${SUPABASE_KEY}`                    }                }            );            if (!relResponse.ok) throw new Error('Failed to load relationships');            const relationships = await relResponse.json();            console.log(`Found ${relationships.length} relationships`);            // Get unique resource paths            const uniquePaths = [...new Set([                ...relationships.map(r => r.source_path),                ...relationships.map(r => r.target_path)            ])].slice(0, 50); // Limit to prevent overcrowding            // Fetch resource details            const pathFilter = uniquePaths.map(p => `"${p}"`).join(',');            const resourceResponse = await fetch(                `${SUPABASE_URL}/rest/v1/graphrag_resources?select=file_path,title,subject&file_path=in.(${pathFilter})`,                {                    headers: {                        'apikey': SUPABASE_KEY,                        'Authorization': `Bearer ${SUPABASE_KEY}`                    }                }            );            if (!resourceResponse.ok) throw new Error('Failed to load resources');            const resources = await resourceResponse.json();            const resourceMap = {};            resources.forEach(r => {                resourceMap[r.file_path] = r;            });            // Build nodes and links            nodesData = resources.map(r => ({                id: r.file_path,                title: r.title || 'Resource',                subject: r.subject || 'General'            }));            linksData = relationships                .filter(r => resourceMap[r.source_path] && resourceMap[r.target_path])                .map(r => ({                    source: r.source_path,                    target: r.target_path,                    type: r.relationship_type,                    confidence: r.confidence                }));            // Update stats            document.getElementById('node-count').textContent = nodesData.length;            document.getElementById('link-count').textContent = linksData.length;            // Create visualization            createVisualization();        } catch (error) {            console.error('Error loading graph:', error);            document.getElementById('graphrag-viz').innerHTML = `                <div style="p-12  text-center ">                    <p style="color: #dc2626; font-semibold  mb-4 ">‚ö†Ô∏è Error loading knowledge graph</p>                    <p style="color: #666;">Try refreshing the page or check your connection.</p>                </div>            `;        }    }    function createVisualization() {        const container = document.getElementById('graphrag-viz');        const width = container.clientWidth;        const height = container.clientHeight;        // Clear existing        container.innerHTML = '';        // Create SVG        svg = d3.select('#graphrag-viz')            .append('svg')            .attr('width', width)            .attr('height', height);        const g = svg.append('g');        // Add zoom behavior        const zoom = d3.zoom()            .scaleExtent([0.1, 4])            .on('zoom', (event) => {                g.attr('transform', event.transform);                transform = event.transform;            });        svg.call(zoom);        // Create simulation        simulation = d3.forceSimulation(nodesData)            .force('link', d3.forceLink(linksData).id(d => d.id).distance(100))            .force('charge', d3.forceManyBody().strength(-300))            .force('center', d3.forceCenter(width / 2, height / 2))            .force('collision', d3.forceCollide().radius(30));        // Create links        linkElements = g.append('g')            .selectAll('line')            .data(linksData)            .enter().append('line')            .attr('class', 'link')            .attr('stroke-width', d => Math.sqrt(d.confidence * 5));        // Create nodes        nodeElements = g.append('g')            .selectAll('circle')            .data(nodesData)            .enter().append('circle')            .attr('class', 'node')            .attr('r', 15)            .attr('fill', d => subjectColors[d.subject] || subjectColors.default)            .call(d3.drag()                .on('start', dragStarted)                .on('drag', dragged)                .on('end', dragEnded))            .on('click', (event, d) => {                console.log('Clicked:', d);                alert(`${d.title}\nSubject: ${d.subject}`);            });        // Add labels        labelElements = g.append('g')            .selectAll('text')            .data(nodesData)            .enter().append('text')            .attr('class', 'node-label')            .text(d => d.title.length > 30 ? d.title.substring(0, 30) + '...' : d.title);        // Update positions on tick        simulation.on('tick', () => {            linkElements                .attr('x1', d => d.source.x)                .attr('y1', d => d.source.y)                .attr('x2', d => d.target.x)                .attr('y2', d => d.target.y);            nodeElements                .attr('cx', d => d.x)                .attr('cy', d => d.y);            labelElements                .attr('x', d => d.x)                .attr('y', d => d.y + 25);        });        console.log('‚úÖ Knowledge graph visualization created');    }    function dragStarted(event, d) {        if (!event.active) simulation.alphaTarget(0.3).restart();        d.fx = d.x;        d.fy = d.y;    }    function dragged(event, d) {        d.fx = event.x;        d.fy = event.y;    }    function dragEnded(event, d) {        if (!event.active) simulation.alphaTarget(0);        d.fx = null;        d.fy = null;    }    window.graphZoomIn = function() {        svg.transition().call(d3.zoom().scaleBy, 1.3);    };    window.graphZoomOut = function() {        svg.transition().call(d3.zoom().scaleBy, 0.7);    };    window.graphReset = function() {        svg.transition().call(d3.zoom().transform, d3.zoomIdentity);        simulation.alpha(1).restart();    };    window.filterGraph = function(filterType) {        console.log('Filtering by:', filterType);        // Implement filtering logic here    };    // Load graph on component mount    loadGraph();})();</script>