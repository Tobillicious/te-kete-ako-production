<!-- ðŸŒŸ PERFECT LEARNING PATHWAYS - GraphRAG-Powered Recommendations -->
<section class="max-w-6xl mx-auto mt-12 px-8">
    <div class="text-center mb-10">
        <div class="inline-block bg-gradient-to-br from-purple-600 to-purple-800 px-8 py-3 rounded-full mb-4">
            <span class="text-white font-extrabold text-base">âœ¨ PERFECT LEARNING PATHWAYS</span>
        </div>
        <h2 class="text-5xl text-primary mb-3 font-extrabold">
            Discover Complete Learning Journeys
        </h2>
        <p class="text-gray-600 text-xl max-w-3xl mx-auto">
            Expertly-crafted unit progressions with 95%+ confidence ratings from our GraphRAG system
        </p>
    </div>

    <!-- Perfect Pathways Grid -->
    <div id="perfect-pathways-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <!-- Dynamically loaded from GraphRAG -->
    </div>

    <div class="text-center mt-8">
        <a href="/units/" class="inline-block gradient-primary text-white px-10 py-4 rounded-full no-underline font-bold text-xl shadow-lg transition-all hover:-translate-y-1 hover:shadow-2xl">
            Explore All Learning Pathways â†’
        </a>
    </div>
</section>

<script>
/**
 * Perfect Pathways Widget - GraphRAG-Powered
 * Uses learning_sequence relationships @ 0.95+ confidence
 */
class PerfectPathwaysWidget {
    constructor() {
        this.supabase = null;
        this.pathways = [];
        this.init();
    }

    async init() {
        // Wait for Supabase singleton
        if (window.supabaseSingleton) {
            this.supabase = await window.supabaseSingleton.getClient();
            await this.loadPathways();
            this.render();
        } else {
            // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        setTimeout(() => this.init(), 500);
        }
    }

    async loadPathways() {
        try {
            // Get top learning sequence chains
            const { data, error } = await this.supabase
                .from('graphrag_relationships')
                .select('source_path, target_path, confidence, metadata')
                .eq('relationship_type', 'learning_sequence')
                .gte('confidence', 0.95)
                .order('confidence', { ascending: false })
                .limit(50);

            if (error) {
                // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        return;
            }

            // Group by unit (source_path)
            const unitMap = new Map();
            data.forEach(rel => {
                if (!unitMap.has(rel.source_path)) {
                    unitMap.set(rel.source_path, {
                        unitPath: rel.source_path,
                        lessons: [],
                        metadata: rel.metadata || {}
                    });
                }
                unitMap.get(rel.source_path).lessons.push(rel.target_path);
            });

            // Convert to array and take top 6 units
            this.pathways = Array.from(unitMap.values())
                .filter(unit => unit.lessons.length >= 3) // At least 3 lessons
                .slice(0, 6);

            console.log(`âœ… Loaded ${this.pathways.length} perfect pathways`);
        } catch (error) {
            // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        }
    }

    render() {
        const container = document.getElementById('perfect-pathways-grid');
        if (!container) return;

        if (this.pathways.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center col-span-3">Loading pathways...</p>';
            return;
        }

        container.innerHTML = this.pathways.map(pathway => {
            const unitName = this.extractUnitName(pathway.unitPath);
            const lessonCount = pathway.lessons.length;
            const yearLevel = pathway.metadata.pedagogical_level || 'Y7-10';
            const { icon, color, borderColor } = this.getUnitStyle(unitName);

            return `
                <a href="${pathway.unitPath}" class="bg-white rounded-2xl p-8 no-underline shadow-xl border-t-6 ${borderColor} transition-all relative hover:-translate-y-2 hover:shadow-2xl">
                    <div class="flex items-center gap-4 mb-4">
                        <span class="text-6xl">${icon}</span>
                        <div>
                            <div class="text-sm ${color} font-semibold uppercase">${yearLevel}</div>
                            <h3 class="text-2xl text-primary font-extrabold leading-tight">${unitName}</h3>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 leading-relaxed mb-6 text-base">
                        Complete ${lessonCount}-lesson sequence with 95%+ learning progression confidence
                    </p>
                    
                    <div class="flex gap-2 flex-wrap mb-4">
                        <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-xl text-sm font-semibold">
                            ðŸ“š ${lessonCount} Lessons
                        </span>
                        <span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-xl text-sm font-semibold">
                            âœ¨ Q95+ Confidence
                        </span>
                        <span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-xl text-sm font-semibold">
                            ðŸŒ¿ Cultural
                        </span>
                    </div>
                    
                    <div class="text-primary font-bold text-lg">
                        Start Learning Journey â†’
                    </div>
                </a>
            `;
        }).join('');
    }

    extractUnitName(path) {
        const nameMatch = path.match(/\/([^\/]+)\/index\.html$/);
        if (nameMatch) {
            return this.humanizeName(nameMatch[1]);
        }
        return 'Learning Unit';
    }

    humanizeName(slug) {
        return slug
            .split('-')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    getUnitStyle(unitName) {
        const lower = unitName.toLowerCase();
        
        if (lower.includes('digital') || lower.includes('kaitiakitanga')) {
            return { icon: 'ðŸ’»', color: 'text-blue-600', borderColor: 'border-blue-500' };
        }
        if (lower.includes('ecology') || lower.includes('ecosystem') || lower.includes('science')) {
            return { icon: 'ðŸŒ¿', color: 'text-emerald-600', borderColor: 'border-emerald-500' };
        }
        if (lower.includes('algebra') || lower.includes('maths') || lower.includes('mathematics')) {
            return { icon: 'ðŸ”¢', color: 'text-amber-600', borderColor: 'border-amber-500' };
        }
        if (lower.includes('walker') || lower.includes('history') || lower.includes('social')) {
            return { icon: 'ðŸ“š', color: 'text-purple-600', borderColor: 'border-purple-500' };
        }
        if (lower.includes('statistics') || lower.includes('data')) {
            return { icon: 'ðŸ“Š', color: 'text-cyan-600', borderColor: 'border-cyan-500' };
        }
        if (lower.includes('critical') || lower.includes('thinking')) {
            return { icon: 'ðŸ§ ', color: 'text-indigo-600', borderColor: 'border-indigo-500' };
        }
        
        return { icon: 'âœ¨', color: 'text-primary', borderColor: 'border-primary' };
    }
}

// Auto-initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new PerfectPathwaysWidget());
} else {
    new PerfectPathwaysWidget();
}
</script>
