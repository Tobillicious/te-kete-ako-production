<!-- GraphRAG Mathematics Hidden Gems Component -->
<section id="math-hidden-gems" class="shadow-xl" >
    <div style="text-center  mb-4 ">
        <span class="inline-block font-extrabold" >ðŸ’Ž MATHEMATICS HIDDEN GEMS</span>
    </div>
    <h2 class="font-extrabold" >Under-connected high-quality resources</h2>
    <p style="text-center  color: #334155; font-size: 0.95rem; mb-6 ">Q90+ with &lt; 5 GraphRAG connections</p>
    <div id="math-gems-grid" style="grid  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.25rem;"></div>
</section>

<script>
(async function(){
    try {
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';
        
        // Use singleton pattern
        const supa = window.supabaseSingleton 
            ? await window.supabaseSingleton.getClient()
            : null;
        
        if (!supa) return;
        
        const grid = document.getElementById('math-gems-grid');
        if (!grid) return;
        
        // 1) Fetch candidates (Q90+, math subjects)
        const { data: candidates } = await supa
            .from('graphrag_resources')
            .select('file_path,title,resource_type,quality_score,year_level')
            .or('subject.ilike.%math%,subject.ilike.%algebra%,subject.ilike.%geometry%,subject.ilike.%calculus%')
            .gte('quality_score', 90)
            .order('quality_score', { ascending: false })
            .limit(24);
        
        if (!candidates || candidates.length === 0) {
            grid.innerHTML = '<div style="text-center  opacity:0.8;">No mathematics gems found yet.</div>';
            return;
        }
        
        // 2) Count connections and filter < 5
        const scored = [];
        for (const r of candidates) {
            try {
                const { count } = await supa
                    .from('graphrag_relationships')
                    .select('id', { count: 'exact', head: true })
                    .or(`source_path.eq.${r.file_path},target_path.eq.${r.file_path}`);
                scored.push({ r, c: count || 0 });
            } catch (e) {
                scored.push({ r, c: 0 });
            }
        }
        
        const gems = scored.filter(x => x.c < 5).sort((a, b) => (b.r.quality_score || 0) - (a.r.quality_score || 0)).slice(0, 8);
        
        // 3) Render
        grid.innerHTML = gems.map(g => {
            const emoji = g.r.resource_type === 'lesson' ? 'ðŸ“š' : (g.r.resource_type === 'handout' ? 'ðŸ“„' : 'âœ¨');
            const link = (g.r.file_path || '').replace('/public', '') || g.r.file_path;
            return `<a href="${link}" class="bg-white$1" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
                <div class="connection-badge absolute font-extrabold" data-resource-path="${g.r.file_path}" >${g.c} links</div>
                <div style="text-2xl  mb-2 ">${emoji}</div>
                <h3 style="color: #0f172a; font-bold  margin-bottom: 0.25rem;">${g.r.title || 'Resource'}</h3>
                <p style="color: #475569; font-size: 0.85rem;">${g.r.year_level || 'All Years'} â€¢ Quality ${g.r.quality_score || 90}</p>
            </a>`;
        }).join('');
        
        // 4) Update live badges
        if (window.graphragCounter && typeof window.graphragCounter.updateAllBadges === 'function') {
            window.graphragCounter.updateAllBadges();
        }
    } catch (e) {
        // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        }
})();
</script>

