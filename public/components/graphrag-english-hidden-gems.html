<!-- GraphRAG English Hidden Gems Component -->
<section id="english-hidden-gems" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #0f172a; p-12  2rem; rounded-2xl  margin: 3rem 0; box-shadow: 0 8px 24px rgba(220,38,38,0.12);">
    <div style="text-center  mb-4 ">
        <span style="display: inline-block; background: rgba(220,38,38,0.12); color: #991b1b; padding: 0.5rem 1.25rem; border-radius: 24px; font-size: 0.85rem; font-weight: 800;">ðŸ’Ž ENGLISH HIDDEN GEMS</span>
    </div>
    <h2 style="font-size: 2rem; font-weight: 800; text-center  margin-bottom: 0.25rem;">Under-connected high-quality resources</h2>
    <p style="text-center  color: #334155; font-size: 0.95rem; mb-6 ">Q90+ with &lt; 5 GraphRAG connections</p>
    <div id="english-gems-grid" style="grid  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.25rem;"></div>
</section>

<script>
(async function(){
    try {
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';
        
        // Use singleton pattern
        const supa = window.supabaseSingleton 
            ? await window.supabaseSingleton.getClient()
            : null;
        
        if (!supa) return;
        
        const grid = document.getElementById('english-gems-grid');
        if (!grid) return;
        
        // Fetch candidates (Q90+, English/Literacy/Writing)
        const { data: candidates } = await supa
            .from('graphrag_resources')
            .select('file_path,title,resource_type,quality_score,year_level')
            .or('subject.ilike.%english%,subject.ilike.%literacy%,subject.ilike.%writing%')
            .gte('quality_score', 90)
            .order('quality_score', { ascending: false })
            .limit(24);
        
        if (!candidates || candidates.length === 0) {
            grid.innerHTML = '<div style="text-center  opacity:0.8;">No English gems found yet.</div>';
            return;
        }
        
        // Count connections
        const scored = [];
        for (const r of candidates) {
            try {
                const { count } = await supa
                    .from('graphrag_relationships')
                    .select('id', { count: 'exact', head: true })
                    .or(`source_path.eq.${r.file_path},target_path.eq.${r.file_path}`);
                scored.push({ r, c: count || 0 });
            } catch (e) {
                scored.push({ r, c: 0 });
            }
        }
        
        const gems = scored.filter(x => x.c < 5).sort((a, b) => (b.r.quality_score || 0) - (a.r.quality_score || 0)).slice(0, 8);
        
        // Render
        grid.innerHTML = gems.map(g => {
            const emoji = g.r.resource_type === 'lesson' ? 'ðŸ“š' : (g.r.resource_type === 'handout' ? 'ðŸ“„' : 'âœ¨');
            const link = (g.r.file_path || '').replace('/public', '') || g.r.file_path;
            return `<a href="${link}" class="bg-white$1" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
                <div class="connection-badge" data-resource-path="${g.r.file_path}" style="position: absolute; top: -12px; right: 12px; background: #fee2e2; color: #991b1b; padding: 0.4rem 0.8rem; border-radius: 18px; font-weight: 800; font-size: 0.75rem;">${g.c} links</div>
                <div style="text-2xl  mb-2 ">${emoji}</div>
                <h3 style="color: #0f172a; font-bold  margin-bottom: 0.25rem;">${g.r.title || 'Resource'}</h3>
                <p style="color: #475569; font-size: 0.85rem;">${g.r.year_level || 'All Years'} â€¢ Quality ${g.r.quality_score || 90}</p>
            </a>`;
        }).join('');
        
        // Update live badges
        if (window.graphragCounter && typeof window.graphragCounter.updateAllBadges === 'function') {
            window.graphragCounter.updateAllBadges();
        }
    } catch (e) {
        // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('error', {
                message: '$2',
                details: $3,
                url: window.location.pathname
            });
        }
        // Show user-friendly message instead of error
        }
})();
</script>

