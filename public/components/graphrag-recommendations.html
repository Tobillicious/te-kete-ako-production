<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     GRAPHRAG RECOMMENDATIONS COMPONENT
     Powered by 1.18M relationships, 959 relationship types, 77.7% avg confidence
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<link rel="stylesheet" href="/css/cascade-fix.css">

<style>
.recommendations-section {
    margin: var(--space-16) 0;
    padding: var(--space-12) var(--space-6);
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: var(--radius-xl);
    border-left: 4px solid var(--color-info);
}

.recommendations-header {
    text-align: center;
    margin-bottom: var(--space-12);
}

.recommendations-title {
    font-size: var(--text-4xl);
    color: var(--color-primary);
    margin-bottom: var(--space-4);
    font-family: var(--font-primary);
}

.recommendations-subtitle {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-6);
    margin-top: var(--space-8);
}

.recommendation-card {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    transition: all var(--transition-fast);
    text-decoration: none;
    color: inherit;
    display: block;
    border-top: 3px solid var(--color-pounamu);
}

.recommendation-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
}

.recommendation-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: rgba(7, 160, 122, 0.1);
    color: var(--color-pounamu);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 700;
    margin-bottom: var(--space-3);
}

.recommendation-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: var(--space-2);
    line-height: var(--line-height-snug);
}

.recommendation-meta {
    display: flex;
    gap: var(--space-4);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
    flex-wrap: wrap;
}

.recommendation-description {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin-bottom: var(--space-4);
}

.recommendation-confidence {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--text-xs);
    color: var(--color-success);
    font-weight: 600;
}

.confidence-bar {
    width: 60px;
    height: 4px;
    background: rgba(16, 185, 129, 0.2);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: var(--color-success);
    transition: width 0.3s ease;
}

.loading-state {
    text-align: center;
    padding: var(--space-16);
    color: var(--color-text-secondary);
}

.spinner {
    border: 3px solid rgba(7, 160, 122, 0.1);
    border-top: 3px solid var(--color-pounamu);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-4);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<section class="recommendations-section">
    <div class="recommendations-header">
        <h2 class="recommendations-title">
            üß† Intelligent Recommendations
        </h2>
        <p class="recommendations-subtitle">
            Powered by GraphRAG - 1.18M relationships across 12,575 resources
        </p>
    </div>

    <div id="recommendations-container">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Discovering perfect resources for you...</p>
        </div>
    </div>
</section>

<script>
(async function() {
    // Use Supabase singleton
    const supabase = window.supabaseSingleton 
        ? await window.supabaseSingleton.getClient()
        : window.supabase;

    if (!supabase) {
        console.warn('[Recommendations] Supabase not available');
        return;
    }

    async function loadRecommendations() {
        try {
            // Get top resources by quality and connections
            const { data: topResources, error } = await supabase
                .rpc('get_top_recommended_resources', {
                    min_quality: 90,
                    limit_count: 6
                });

            if (error) {
                // Fallback: Get top quality resources directly
                const { data: fallbackData } = await supabase
                    .from('graphrag_resources')
                    .select('file_path, title, quality_score, subject, year_level, resource_type, has_whakataukƒ´')
                    .eq('archive_status', 'active')
                    .gte('quality_score', 90)
                    .order('quality_score', { ascending: false })
                    .limit(6);
                
                renderRecommendations(fallbackData || []);
                return;
            }

            renderRecommendations(topResources || []);
        } catch (err) {
            console.error('[Recommendations] Error:', err);
            document.getElementById('recommendations-container').innerHTML = 
                '<p style="text-align: center; color: var(--color-text-secondary);">Unable to load recommendations. Please refresh.</p>';
        }
    }

    function renderRecommendations(resources) {
        const container = document.getElementById('recommendations-container');
        
        if (!resources || resources.length === 0) {
            container.innerHTML = '<p style="text-align: center;">No recommendations available at this time.</p>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'recommendations-grid';

        resources.forEach(resource => {
            const card = createRecommendationCard(resource);
            grid.appendChild(card);
        });

        container.innerHTML = '';
        container.appendChild(grid);
    }

    function createRecommendationCard(resource) {
        const card = document.createElement('a');
        card.className = 'recommendation-card';
        card.href = resource.file_path || '#';

        const badge = document.createElement('span');
        badge.className = 'recommendation-badge';
        badge.textContent = resource.has_whakataukƒ´ ? 'üåø Culturally Integrated' : '‚≠ê Gold Standard';

        const title = document.createElement('h3');
        title.className = 'recommendation-title';
        title.textContent = resource.title || 'Resource';

        const meta = document.createElement('div');
        meta.className = 'recommendation-meta';
        if (resource.subject) {
            const subjectSpan = document.createElement('span');
            subjectSpan.textContent = `üìö ${resource.subject}`;
            meta.appendChild(subjectSpan);
        }
        if (resource.year_level) {
            const yearSpan = document.createElement('span');
            yearSpan.textContent = `üéØ ${resource.year_level}`;
            meta.appendChild(yearSpan);
        }
        if (resource.resource_type) {
            const typeSpan = document.createElement('span');
            typeSpan.textContent = resource.resource_type;
            meta.appendChild(typeSpan);
        }

        const description = document.createElement('p');
        description.className = 'recommendation-description';
        description.textContent = resource.content_preview || 'High-quality resource with excellent cultural integration.';

        const confidence = document.createElement('div');
        confidence.className = 'recommendation-confidence';
        
        const qualityScore = resource.quality_score || 90;
        const confidenceText = document.createElement('span');
        confidenceText.textContent = `Quality: ${qualityScore}/100`;
        
        const bar = document.createElement('div');
        bar.className = 'confidence-bar';
        const fill = document.createElement('div');
        fill.className = 'confidence-fill';
        fill.style.width = `${qualityScore}%`;
        bar.appendChild(fill);

        confidence.appendChild(confidenceText);
        confidence.appendChild(bar);

        card.appendChild(badge);
        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(description);
        card.appendChild(confidence);

        return card;
    }

    // Load on component ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadRecommendations);
    } else {
        loadRecommendations();
    }
})();
</script>
