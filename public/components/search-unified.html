<!-- =================================================================
   UNIFIED SEARCH SYSTEM - Te Kete Ako
   Merged from 3 search implementations for optimal performance

   Features Combined:
   ‚úÖ Basic Search: Simple, reliable search with suggestions
   ‚úÖ Global Search: GraphRAG-powered intelligent search
   ‚úÖ Semantic Search: Enhanced cultural context awareness
   ‚úÖ Cultural Keywords: MƒÅori language and concept recognition
   ‚úÖ Mobile Optimized: Touch-friendly responsive design

   Date: October 25, 2025
   ================================================================= -->

<!-- SEARCH CONTAINER - Responsive and Accessible -->
<div class="search-unified-container">
    <!-- SEARCH FORM -->
    <form class="search-form" role="search" action="/search-results.html" method="get">
        <div class="search-input-wrapper">
            <input
                type="search"
                class="search-input"
                name="q"
                id="unified-search-input"
                placeholder="Search resources, lessons, units... (e.g., 'kaitiakitanga', 'algebra whakapapa')"
                aria-label="Search Te Kete Ako resources"
                autocomplete="off"
                data-cultural-keywords="mƒÅori,maori,te reo,whakataukƒ´,whakatauki,kaitiakitanga,manaakitanga,whanaungatanga,rangatiratanga,tikanga,mƒÅtauranga,matauranga,p≈´rƒÅkau,purakau,whakapapa,taonga,iwi,hap≈´,hapu,marae"
                data-subject-keywords="math,mathematics,science,english,social studies,digital technology,te reo mƒÅori,te reo maori,arts,health,pe"
            />
            <button type="submit" class="search-button" aria-label="Submit search">
                <span class="search-icon">üîç</span>
            </button>
        </div>

        <!-- SEARCH SUGGESTIONS -->
        <div class="search-suggestions" id="search-suggestions" style="display: none;">
            <div class="suggestions-header">
                <span class="suggestions-title">üí° Suggestions</span>
                <span class="suggestions-subtitle">Try these search terms:</span>
            </div>
            <div class="suggestions-grid">
                <button class="suggestion-tag cultural" data-query="kaitiakitanga">
                    üåø Kaitiakitanga
                </button>
                <button class="suggestion-tag cultural" data-query="whakataukƒ´">
                    üí¨ Whakataukƒ´
                </button>
                <button class="suggestion-tag cultural" data-query="whakapapa">
                    üß¨ Whakapapa
                </button>
                <button class="suggestion-tag subject" data-query="mathematics mƒÅori">
                    üî¢ MƒÅori Mathematics
                </button>
                <button class="suggestion-tag subject" data-query="science ecology">
                    üî¨ Ecology
                </button>
                <button class="suggestion-tag subject" data-query="english narrative">
                    üìù Narrative Writing
                </button>
                <button class="suggestion-tag general" data-query="year 8">
                    üìö Year 8
                </button>
                <button class="suggestion-tag general" data-query="gold standard">
                    ‚≠ê Gold Standard
                </button>
            </div>
        </div>

        <!-- GRAPHRAG RESULTS -->
        <div class="graphrag-search-results" id="graphrag-search-results" style="display: none;"></div>
    </form>
</div>

<style>
/* UNIFIED SEARCH STYLES - Best of all search systems */

/* Container */
.search-unified-container {
    margin: 2rem auto;
    padding: 0 1rem;
}

/* Search Form */
.search-form {
    }

.search-input-wrapper {
    align-items: center;
    border-radius: 50px;
    transition: all 0.3s ease;
    border: 3px solid transparent;
}

.search-input-wrapper:focus-within {
    box-shadow: 0 8px 24px rgba(26, 77, 46, 0.2);
    transform: translateY(-2px);
    border-}

.search-input {
    padding: 1rem 4rem 1rem 1.5rem;
    border: none;
    border-radius: 50px;
    font-family: var(--font-body, 'Inter', sans-serif);
    transition: all 0.3s ease;
    color: var(--color-text, #2c3e50);
}

.search-input:focus {
    outline: none;
}

.search-input::placeholder {
    color: var(--color-gray-400, #9ca3af);
    }

.search-button {
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    border: none;
    background: var(--color-primary, #1a4d2e);
    color: white;
    border-radius: 50%;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.25rem;
}

.search-button:hover {
    background: var(--color-accent, #7a6b1f);
    transform: translateY(-50%) scale(1.05);
}

.search-button:focus {
    outline: 3px solid rgba(74, 110, 42, 0.3);
    outline-offset: 2px;
}

/* Search Suggestions */
.search-suggestions {
    top: 100%;
    left: 0;
    right: 0;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    margin-top: 0.5rem;
    max-overflow-y: auto;
    z-index: 1000;
    }

.suggestions-header {
    }

.suggestions-title {
    color: var(--color-primary, #1a4d2e);
    }

.suggestions-subtitle {
    font-size: 0.85rem;
    color: var(--color-text-secondary, #6b7280);
}

.suggestions-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}

.suggestion-tag {
    padding: 0.75rem 1rem;
    border: 2px solid;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.2s ease;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.suggestion-tag.cultural {
    border-color: var(--color-success, #10b981);
    color: var(--color-success, #10b981);
}

.suggestion-tag.subject {
    border-color: var(--color-info, #3b82f6);
    color: var(--color-info, #3b82f6);
}

.suggestion-tag.general {
    border-color: var(--color-warning, #f59e0b);
    color: var(--color-warning, #f59e0b);
}

.suggestion-tag:hover {
    transform: translateY(-2px);
    }

.suggestion-tag.cultural:hover {
    background: var(--color-success, #10b981);
    color: white;
}

.suggestion-tag.subject:hover {
    background: var(--color-info, #3b82f6);
    color: white;
}

.suggestion-tag.general:hover {
    background: var(--color-warning, #f59e0b);
    color: white;
}

/* GraphRAG Results */
.graphrag-search-results {
    top: 100%;
    left: 0;
    right: 0;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    margin-top: 0.5rem;
    max-overflow-y: auto;
    z-index: 1000;
    }

.search-result-card {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: inherit;
}

.search-result-card:hover {
    background: var(--color-gray-50, #f9fafb);
    transform: translateX(4px);
}

.search-result-card:last-child {
    border-bottom: none;
}

.search-result-title {
    color: var(--color-primary, #1a4d2e);
    }

.search-result-meta {
    font-size: 0.85rem;
    color: var(--color-text-secondary, #6b7280);
    }

.search-result-preview {
    font-size: 0.85rem;
    color: var(--color-text, #2c3e50);
    line-margin-bottom: 0.75rem;
}

.search-result-badges {
    gap: 0.5rem;
    flex-wrap: wrap;
}

.badge {
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    }

.badge.cultural {
    background: var(--color-success, #10b981);
    color: white;
}

.badge.quality {
    background: var(--color-warning, #f59e0b);
    color: white;
}

.badge.te-reo {
    background: var(--color-info, #3b82f6);
    color: white;
}

.badge.whakatauki {
    background: var(--color-accent, #d4a574);
    color: white;
}

/* Mobile Responsive */
@media (padding: 0 0.5rem;
    }

    .search-input {
        padding: 0.875rem 3.5rem 0.875rem 1rem;
        }

    .search-button {
        width: 40px;
        }

    .suggestions-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }

    .suggestion-tag {
        padding: 0.5rem 0.75rem;
        }
}

@media (}

    .search-suggestions {
        }
}

/* Print - Hide Search */
@media print {
    .search-unified-container {
        display: none !important;
    }
}
</style>

<script>
/**
 * UNIFIED SEARCH FUNCTIONALITY
 * Combines best features from all search implementations
 */
(function() {
    'use strict';

    // Elements
    const searchInput = document.getElementById('unified-search-input');
    const searchSuggestions = document.getElementById('search-suggestions');
    const graphragResults = document.getElementById('graphrag-search-results');

    // Configuration
    const CULTURAL_KEYWORDS = [
        'mƒÅori', 'maori', 'te reo', 'whakataukƒ´', 'whakatauki',
        'kaitiakitanga', 'manaakitanga', 'whanaungatanga', 'rangatiratanga',
        'tikanga', 'mƒÅtauranga', 'matauranga', 'p≈´rƒÅkau', 'purakau',
        'whakapapa', 'taonga', 'iwi', 'hap≈´', 'hapu', 'marae'
    ];

    const SUBJECT_KEYWORDS = [
        'math', 'mathematics', 'science', 'english', 'social studies',
        'digital technology', 'te reo mƒÅori', 'te reo maori', 'arts', 'health', 'pe'
    ];

    // Initialize search
    function initializeSearch() {
        if (!searchInput || !searchSuggestions || !graphragResults) {
            // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('error', {
        message: '$2',
        details: $3,
        url: window.location.pathname
    });
        }
        // Show user-friendly message instead of error
        return;
        }

        setupEventListeners();
        // User feedback provided via UI
    }

    // Event listeners
    function setupEventListeners() {
        let debounceTimer;

        // Input events
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value.trim();

            if (query.length === 0) {
                hideSuggestions();
                return;
            }

            if (query.length < 2) {
                showSuggestions(query);
                return;
            }

            debounceTimer = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        // Focus events
        searchInput.addEventListener('focus', () => {
            const query = searchInput.value.trim();
            if (query.length >= 2) {
                performSearch(query);
            } else {
                showSuggestions(query);
            }
        });

        // Click outside to close
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-unified-container')) {
                hideSuggestions();
                hideGraphRAGResults();
            }
        });

        // Suggestion tag clicks
        searchSuggestions.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-tag')) {
                const query = e.target.dataset.query;
                if (query) {
                    searchInput.value = query;
                    performSearch(query);
                }
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideSuggestions();
                hideGraphRAGResults();
            }
        });
    }

    // Show suggestions for short queries
    function showSuggestions(query) {
        const suggestionsHTML = `
            <div class="suggestions-header">
                <span class="suggestions-title">üí° Suggestions</span>
                <span class="suggestions-subtitle">Try these search terms:</span>
            </div>
            <div class="suggestions-grid">
                ${generateSuggestions(query)}
            </div>
        `;

        searchSuggestions.innerHTML = suggestionsHTML;
        searchSuggestions.style.display = 'block';
        graphragResults.style.display = 'none';
    }

    // Generate intelligent suggestions based on query
    function generateSuggestions(query) {
        const lowerQuery = query.toLowerCase();
        const suggestions = [];

        // Cultural suggestions
        CULTURAL_KEYWORDS.forEach(keyword => {
            if (keyword.includes(lowerQuery) && !query.includes(keyword)) {
                suggestions.push(`
                    <button class="suggestion-tag cultural" data-query="${keyword}">
                        üåø ${keyword.charAt(0).toUpperCase() + keyword.slice(1)}
                    </button>
                `);
            }
        });

        // Subject suggestions
        SUBJECT_KEYWORDS.forEach(keyword => {
            if (keyword.includes(lowerQuery) && !query.includes(keyword)) {
                suggestions.push(`
                    <button class="suggestion-tag subject" data-query="${keyword}">
                        üìö ${keyword.charAt(0).toUpperCase() + keyword.slice(1)}
                    </button>
                `);
            }
        });

        // Default suggestions if no matches
        if (suggestions.length === 0) {
            suggestions.push(`
                <button class="suggestion-tag cultural" data-query="kaitiakitanga">
                    üåø Kaitiakitanga
                </button>
                <button class="suggestion-tag cultural" data-query="whakataukƒ´">
                    üí¨ Whakataukƒ´
                </button>
                <button class="suggestion-tag cultural" data-query="whakapapa">
                    üß¨ Whakapapa
                </button>
                <button class="suggestion-tag subject" data-query="mathematics mƒÅori">
                    üî¢ MƒÅori Mathematics
                </button>
                <button class="suggestion-tag subject" data-query="science ecology">
                    üî¨ Ecology
                </button>
                <button class="suggestion-tag subject" data-query="english narrative">
                    üìù Narrative Writing
                </button>
                <button class="suggestion-tag general" data-query="year 8">
                    üìö Year 8
                </button>
                <button class="suggestion-tag general" data-query="gold standard">
                    ‚≠ê Gold Standard
                </button>
            `);
        }

        return suggestions.join('');
    }

    // Perform GraphRAG-powered search
    async function performSearch(query) {
        try {
            showLoadingState();

            // Use GraphRAG search with cultural intelligence
            const results = await enhancedCulturalSearch(query);

            if (results && results.length > 0) {
                displayGraphRAGResults(results, query);
            } else {
                showNoResults(query);
            }
        } catch (error) {
            // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('error', {
        message: '$2',
        details: $3,
        url: window.location.pathname
    });
        }
        // Show user-friendly message instead of error
        showErrorState();
        }
    }

    // Enhanced cultural search using GraphRAG
    async function enhancedCulturalSearch(query) {
        // Parse query for cultural and semantic terms
        const { culturalTerms, subjectTerms, generalTerms } = parseQuery(query);

        try {
            // Use Supabase GraphRAG API
            const response = await fetch(
                `https://nlgldaqtubrlcqddppbq.supabase.co/rest/v1/graphrag_resources?` +
                `is_active=eq.true&` +
                `or=(${buildSearchConditions(culturalTerms, subjectTerms, generalTerms)})&` +
                `limit=10&` +
                `select=*`,
                {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM'
                    }
                }
            );

            const data = await response.json();

            // Enhance results with cultural context
            return enhanceResultsWithCulturalContext(data, query);

        } catch (error) {
            // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('error', {
        message: '$2',
        details: $3,
        url: window.location.pathname
    });
        }
        // Show user-friendly message instead of error
        return [];
        }
    }

    // Parse query for intelligent search
    function parseQuery(query) {
        const lowerQuery = query.toLowerCase();
        const culturalTerms = [];
        const subjectTerms = [];
        const generalTerms = [];

        // Extract cultural terms
        CULTURAL_KEYWORDS.forEach(keyword => {
            if (lowerQuery.includes(keyword)) {
                culturalTerms.push(keyword);
            }
        });

        // Extract subject terms
        SUBJECT_KEYWORDS.forEach(keyword => {
            if (lowerQuery.includes(keyword)) {
                subjectTerms.push(keyword);
            }
        });

        // Remaining terms
        const queryWords = query.split(' ').filter(word => word.length > 2);
        queryWords.forEach(word => {
            const lowerWord = word.toLowerCase();
            if (!culturalTerms.includes(lowerWord) && !subjectTerms.includes(lowerWord)) {
                generalTerms.push(word);
            }
        });

        return { culturalTerms, subjectTerms, generalTerms };
    }

    // Build search conditions for Supabase
    function buildSearchConditions(culturalTerms, subjectTerms, generalTerms) {
        const conditions = [];

        if (culturalTerms.length > 0) {
            const culturalOr = culturalTerms.map(term =>
                `title.ilike.*${term}*,subject.ilike.*${term}*,content_preview.ilike.*${term}*`
            ).join(',');
            conditions.push(`(${culturalOr})`);
        }

        if (subjectTerms.length > 0) {
            const subjectOr = subjectTerms.map(term =>
                `subject.ilike.*${term}*`
            ).join(',');
            conditions.push(`(${subjectOr})`);
        }

        if (generalTerms.length > 0) {
            const generalOr = generalTerms.map(term =>
                `title.ilike.*${term}*,content_preview.ilike.*${term}*`
            ).join(',');
            conditions.push(`(${generalOr})`);
        }

        return conditions.length > 0 ? conditions.join(' or ') : `title.ilike.*${query}*`;
    }

    // Enhance results with cultural context
    function enhanceResultsWithCulturalContext(results, query) {
        return results.map(resource => ({
            ...resource,
            relevance_score: calculateRelevanceScore(resource, query),
            cultural_badge: resource.cultural_context ? 'üåø Cultural' : '',
            quality_badge: resource.quality_score >= 90 ? `‚≠ê ${resource.quality_score}` : '',
            te_reo_badge: resource.has_te_reo ? 'üó£Ô∏è Te Reo' : '',
            whakatauki_badge: resource.has_whakataukƒ´ ? 'üí¨ Whakataukƒ´' : ''
        })).sort((a, b) => b.relevance_score - a.relevance_score);
    }

    // Calculate relevance score
    function calculateRelevanceScore(resource, query) {
        let score = 0;
        const lowerQuery = query.toLowerCase();
        const lowerTitle = resource.title.toLowerCase();

        // Exact title match gets highest score
        if (lowerTitle === lowerQuery) score += 100;

        // Title contains query
        if (lowerTitle.includes(lowerQuery)) score += 50;

        // Query words in title
        query.split(' ').forEach(word => {
            if (lowerTitle.includes(word.toLowerCase())) score += 10;
        });

        // Cultural context bonus
        if (resource.cultural_context) score += 20;

        // High quality bonus
        if (resource.quality_score >= 90) score += 15;

        // Te Reo bonus
        if (resource.has_te_reo) score += 10;

        // Whakataukƒ´ bonus
        if (resource.has_whakataukƒ´) score += 10;

        return score;
    }

    // Display GraphRAG results
    function displayGraphRAGResults(results, query) {
        const resultsHTML = `
            <div class="p-4 rounded-xl" style="color: white; padding: 1rem 1.5rem; border-radius: 12px 12px 0 0;"
                <p >
                    üîç Found <strong>${results.length}</strong> results for "<strong>${query}</strong>"
                </p>
                <p class="m-0" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; opacity: 0.9;"
                    Ranked by cultural relevance and quality
                </p>
            </div>
            <div style="max-overflow-y: auto; ">
                ${results.map(resource => createResultCard(resource)).join('')}
            </div>
        `;

        graphragResults.innerHTML = resultsHTML;
        graphragResults.style.display = 'block';
        searchSuggestions.style.display = 'none';
    }

    // Create result card
    function createResultCard(resource) {
        const path = resource.file_path.startsWith('/') ? resource.file_path : `/${resource.file_path}`;
        return `
            <a href="${path}" class="search-result-card">
                <div style="justify-content: space-between; align-items: start; ">
                    <h4 style="color: ${resource.cultural_context ? '#15803d' : '#1a4d2e'}; ">
                        ${resource.title}
                    </h4>
                    <span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.75rem; font-size: 0.75rem; white-space: nowrap; margin-left: 1rem;">
                        ${resource.quality_badge || `‚òÖ ${resource.quality_score}`}
                    </span>
                </div>
                <p style="color: #64748b; font-size: 0.85rem; ">
                    ${resource.year_level || 'All Levels'} ‚Ä¢ ${resource.subject || 'General'} ‚Ä¢ ${resource.resource_type || 'Resource'}
                </p>
                ${resource.content_preview ? `
                    <p style="color: #475569; font-size: 0.85rem; line-margin-bottom: 0.75rem;">
                        ${resource.content_preview.substring(0, 150)}...
                    </p>
                ` : ''}
                <div style="gap: 0.5rem; flex-wrap: wrap;">
                    ${resource.cultural_badge ? `<span class="badge cultural">${resource.cultural_badge}</span>` : ''}
                    ${resource.te_reo_badge ? `<span class="badge te-reo">${resource.te_reo_badge}</span>` : ''}
                    ${resource.whakatauki_badge ? `<span class="badge whakatauki">${resource.whakatauki_badge}</span>` : ''}
                </div>
            </a>
        `;
    }

    // Loading state
    function showLoadingState() {
        graphragResults.innerHTML = `
            <div style="padding: 3rem; ">
                <div class="m-0" style="width: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #1a4d2e; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"</div>
                <p >Searching...</p>
                <p class="m-0" style="color: #6b7280; margin: 0.5rem 0 0 0;"Searching across 20,000+ resources with GraphRAG intelligence</p>
            </div>
        `;
        graphragResults.style.display = 'block';
        searchSuggestions.style.display = 'none';
    }

    // No results state
    function showNoResults(query) {
        graphragResults.innerHTML = `
            <div style="padding: 3rem; ">
                <p class="m-0" style="color: #92400e; margin: 0 0 0.5rem 0;"üîç No results found</p>
                <p class="m-0" style="color: #78350f; margin: 0 0 1rem 0;"Try different keywords or browse by subject</p>
                <div style="gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                    <button class="suggestion-tag cultural" data-query="kaitiakitanga" class="p-2" style="padding: 0.5rem 0.75rem;"üåø Kaitiakitanga</button>
                    <button class="suggestion-tag subject" data-query="mathematics" class="p-2" style="padding: 0.5rem 0.75rem;"üî¢ Mathematics</button>
                    <button class="suggestion-tag subject" data-query="science" class="p-2" style="padding: 0.5rem 0.75rem;"üî¨ Science</button>
                </div>
            </div>
        `;
        graphragResults.style.display = 'block';
        searchSuggestions.style.display = 'none';
    }

    // Error state
    function showErrorState() {
        graphragResults.innerHTML = `
            <div style="padding: 3rem; ">
                <p class="m-0" style="color: #dc2626; margin: 0 0 0.5rem 0;"‚ùå Search Error</p>
                <p style="color: #991b1b; ">Please try again or browse by subject</p>
            </div>
        `;
        graphragResults.style.display = 'block';
        searchSuggestions.style.display = 'none';
    }

    // Hide functions
    function hideSuggestions() {
        searchSuggestions.style.display = 'none';
    }

    function hideGraphRAGResults() {
        graphragResults.style.display = 'none';
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeSearch);
    } else {
        initializeSearch();
    }
})();
</script>