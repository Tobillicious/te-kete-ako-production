<!DOCTYPE html>
<html lang="en">
<head>
    <title>Agent Workload Dashboard | Te Kete Ako</title>

<!-- UNIFIED DESIGN SYSTEM -->
<!-- PWA Manifest -->
<link href="/manifest.json" rel="manifest"/>
<meta content="#1a4d2e" name="theme-color"/>

<!-- CSS - UNIFIED PROFESSIONAL DESIGN SYSTEM (CONSOLIDATED) -->
<!-- ⭐ PROFESSIONAL SYSTEM FIRST - Core design tokens -->


<!-- ⭐ THEME SYSTEM (Tailwind + Ultimate Beauty) -->



<!-- ⭐ COMPONENT STYLES -->





<!-- ⭐ PRINT STYLES (media="print" = only for printing) -->



<!-- ⭐ TAILWIND (Loads second-to-last - utilities only, NO DUPLICATES) -->


<!-- ⭐ CASCADE FIX (Loads LAST - overrides conflicting variables) -->


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Wait for Supabase CDN to load before initializing singleton
    window.addEventListener('DOMContentLoaded', () => {
        if (!window.supabase) {
            // Log to monitoring instead of console
            if (window.posthog) {
                posthog.capture('supabase_cdn_error', {
                    message: 'Supabase CDN failed to load',
                    url: window.location.pathname
                });
            }
        }
    });
</script>
<script src="/js/supabase-singleton.js"></script>
<!-- My Kete Database Integration - loads after singleton -->
<script src="/js/my-kete-database.js"></script>
<!-- Navigation Loader Singleton - loads after supabase setup -->
<script src="/js/navigation-loader.js"></script>
<!-- Component Loader - centralized async component management -->
<script src="/js/component-loader.js"></script>
<meta name="mobile-web-app-capable" content="yes"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Te Kete Ako" name="apple-mobile-web-app-title"/>
<link href="/icons/icon-192x192.png" rel="apple-touch-icon"/>
<!-- ENHANCED SEARCH -->
<script src="/js/enhanced-search.js" defer></script>
<!-- MOBILE PERFORMANCE OPTIMIZER -->
<script src="/js/mobile-performance-optimizer.js" defer></script>
<!-- TOUCH TARGET AUDITOR -->
<script src="/js/touch-target-auditor.js" defer></script>
<!-- 🎨 ULTIMATE CULTURAL GESTURES - Framer Motion System -->
<script src="/js/framer-cultural-gestures-ultimate.js" defer></script>
<!-- Service Worker Registration -->
<script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('✅ PWA: Service Worker registered!', registration);
                    })
                    .catch(error => {
                        // Log to monitoring instead of console
                        if (window.posthog) {
                            posthog.capture('pwa_service_worker_error', {
                                message: 'Service Worker registration failed',
                                error: error.message,
                                url: window.location.pathname
                            });
                        }
                    });
            });
        }
</script>

<meta name="robots" content="index, follow"/>
<meta name="googlebot" content="index, follow"/>
<meta name="theme-color" content="#1a4d2e"/>



<meta name="robots" content="index, follow"/>
<meta name="googlebot" content="index, follow"/>
<meta name="theme-color" content="#1a4d2e"/>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- UNIFIED DESIGN SYSTEM -->
<!-- PWA Manifest -->
<link href="/manifest.json" rel="manifest"/>
<meta content="#1a4d2e" name="theme-color"/>

<!-- CSS - UNIFIED PROFESSIONAL DESIGN SYSTEM (CONSOLIDATED) -->
<!-- ⭐ PROFESSIONAL SYSTEM FIRST - Core design tokens -->


<!-- ⭐ THEME SYSTEM (Tailwind + Ultimate Beauty) -->



<!-- ⭐ COMPONENT STYLES -->
    
    
    
    

<!-- ⭐ PRINT STYLES (media="print" = only for printing) -->
    


<!-- ⭐ TAILWIND (Loads second-to-last - utilities only, NO DUPLICATES) -->


<!-- ⭐ CASCADE FIX (Loads LAST - overrides conflicting variables) -->

<body style="min-">
    
    <header style="color: white; ">
        <div class="m-0 mx-auto" <h1 >👥 Agent Workload Dashboard</h1>
            <p class="m-0" style="opacity: 0.9; margin: 0.5rem 0 0 0;"Real-time team performance & load balancing</p>
        </div>
    </header>

    <main style="margin: 2rem auto; padding: 0 2rem;">
        
        <!-- Team Overview -->
        <section style="box-shadow: 0 2px 12px rgba(0,0,0,0.08); ">
            <h2 class="m-0" style="font-size: 1.5rem; margin: 0 0 1rem 0;"Team Overview</h2>
            <div id="team-stats" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Workload Distribution Chart -->
        <section style="box-shadow: 0 2px 12px rgba(0,0,0,0.08); ">
            <h2 class="m-0" style="font-size: 1.5rem; margin: 0 0 1rem 0;"Workload Distribution</h2>
            <canvas id="workload-chart" height="80"></canvas>
        </section>

        <!-- Agent Cards -->
        <section>
            <h2 class="m-0" style="font-size: 1.5rem; margin: 0 0 1rem 0;"Individual Agent Status</h2>
            <div id="agent-cards" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                <!-- Populated by JS -->
            </div>
        </section>

    </main>

    <script>
        const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const AGENT_COLORS = {
            'kaitiaki-aronui': '#8b5cf6',
            'kaituhi-ako': '#10b981',
            'kaiarahi-kounga': '#3b82f6',
            'kaitiaki-ahurea': '#f59e0b',
            'kaihapai-hononga': '#ec4899',
            'kaimahi-punaha': '#6366f1',
            'kaiako-css': '#14b8a6',
            'kaitiaki-whakamana': '#f97316',
            'kaihanga-rauemi': '#a855f7',
            'kaiarahi-tuhono': '#06b6d4',
            'kaitatari-raraunga': '#84cc16',
            'kaituhi-tuhinga': '#64748b'
        };
        
        async function loadDashboard() {
            try {
                // Load agents
                const { data: agents } = await supabase
                    .from('agent_coordination')
                    .select('*')
                    .order('agent_name');
                
                // Load tasks
                const { data: tasks } = await supabase
                    .from('task_queue')
                    .select('*');
                
                // Calculate workload per agent
                const workload = {};
                
                agents.forEach(agent => {
                    const agentId = agent.agent_name.toLowerCase().replace(/\s+/g, '-').replace(/ā/g, 'a').replace(/ē/g, 'e').replace(/ī/g, 'i').replace(/ō/g, 'o').replace(/ū/g, 'u');
                    workload[agentId] = {
                        name: agent.agent_name,
                        role: agent.task_claimed,
                        status: agent.status,
                        tier: agent.key_decisions?.tier || 4,
                        pending: 0,
                        in_progress: 0,
                        completed: 0,
                        total: 0
                    };
                });
                
                tasks.forEach(task => {
                    if (task.assigned_to && workload[task.assigned_to]) {
                        workload[task.assigned_to].total++;
                        if (task.status === 'pending') workload[task.assigned_to].pending++;
                        if (task.status === 'in_progress') workload[task.assigned_to].in_progress++;
                        if (task.status === 'completed') workload[task.assigned_to].completed++;
                    }
                });
                
                displayTeamStats(agents, tasks);
                displayWorkloadChart(workload);
                displayAgentCards(workload, tasks);
                
            } catch (error) {
                // Log to monitoring instead of console
        if (window.posthog) {
            posthog.capture('javascript_error', {
                error: err.message,
                url: window.location.pathname
            }));
        }
        // Show user-friendly message instead of error
        }
        }
        
        function displayTeamStats(agents, tasks) {
            const activeAgents = agents.filter(a => a.status !== 'idle').length;
            const busyAgents = Object.values(tasks).filter(t => t.status === 'in_progress').map(t => t.assigned_to);
            const uniqueBusy = [...new Set(busyAgents)].length;
            
            document.getElementById('team-stats').innerHTML = `
                <div style="border-radius: 10px;">
                    <div style="font-size: 2.5rem; color: #1e40af;">${agents.length}</div>
                    <div style="color: #1e40af; ">Total Agents</div>
                </div>
                <div style="border-radius: 10px;">
                    <div style="font-size: 2.5rem; color: #065f46;">${uniqueBusy}</div>
                    <div style="color: #065f46; ">Currently Working</div>
                </div>
                <div style="border-radius: 10px;">
                    <div style="font-size: 2.5rem; color: #92400e;">${tasks.filter(t => t.status === 'pending').length}</div>
                    <div style="color: #92400e; ">Tasks Pending</div>
                </div>
                <div style="border-radius: 10px;">
                    <div style="font-size: 2.5rem; color: #991b1b;">${tasks.filter(t => t.status === 'completed').length}</div>
                    <div style="color: #991b1b; ">Completed Today</div>
                </div>
            `;
        }
        
        function displayWorkloadChart(workload) {
            const ctx = document.getElementById('workload-chart').getContext('2d');
            const agents = Object.values(workload).sort((a, b) => b.total - a.total);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: agents.map(a => a.name),
                    datasets: [
                        {
                            label: 'Completed',
                            data: agents.map(a => a.completed),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'In Progress',
                            data: agents.map(a => a.in_progress),
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'Pending',
                            data: agents.map(a => a.pending),
                            backgroundColor: '#f59e0b'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Tasks by Agent (Stacked)' }
                    }
                }
            });
        }
        
        function displayAgentCards(workload, tasks) {
            const container = document.getElementById('agent-cards');
            const agents = Object.entries(workload).sort((a, b) => b[1].total - a[1].total);
            
            container.innerHTML = agents.map(([agentId, data]) => {
                const color = AGENT_COLORS[agentId] || '#64748b';
                const utilization = data.total > 0 ? Math.round(((data.in_progress + data.completed) / data.total) * 100) : 0;
                const agentTasks = tasks.filter(t => t.assigned_to === agentId);
                const avgTime = agentTasks.filter(t => t.completed_at && t.started_at).length > 0 
                    ? agentTasks.filter(t => t.completed_at && t.started_at)
                        .reduce((acc, t) => acc + (new Date(t.completed_at) - new Date(t.started_at)), 0) 
                        / agentTasks.filter(t => t.completed_at).length / 1000 / 60
                    : 0;
                
                return `
                    <div style="box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; border-top: 4px solid ${color};">
                        <div >
                            <div style="justify-content: space-between; align-items: start; ">
                                <div>
                                    <h3 style="color: #1e293b;">${data.name}</h3>
                                    <p class="m-0" style="color: #64748b; margin: 0.25rem 0 0 0;"${data.role}</p>
                                </div>
                                <span style="background: ${color}; color: white; padding: 0.25rem 0.75rem; font-size: 0.75rem; ">
                                    TIER ${data.tier}
                                </span>
                            </div>
                            
                            <div style="grid-template-columns: repeat(3, 1fr); gap: 0.75rem; ">
                                <div style="background: #fef3c7; ">
                                    <div style="font-size: 1.5rem; color: #92400e;">${data.pending}</div>
                                    <div style="font-size: 0.75rem; color: #78350f;">Pending</div>
                                </div>
                                <div style="background: #dbeafe; ">
                                    <div style="font-size: 1.5rem; color: #1e40af;">${data.in_progress}</div>
                                    <div style="font-size: 0.75rem; color: #1e3a8a;">In Progress</div>
                                </div>
                                <div style="background: #dcfce7; ">
                                    <div style="font-size: 1.5rem; color: #065f46;">${data.completed}</div>
                                    <div style="font-size: 0.75rem; color: #064e3b;">Completed</div>
                                </div>
                            </div>
                            
                            ${avgTime > 0 ? `
                                <div style="background: #f8fafc; ">
                                    <div style="justify-content: space-between; font-size: 0.85rem;">
                                        <span style="color: #64748b;">Avg Completion Time:</span>
                                        <strong style="color: #1e293b;">${Math.round(avgTime)} minutes</strong>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Utilization Bar -->
                            <div style="margin-top: 1rem;">
                                <div style="justify-content: space-between; ">
                                    <span style="font-size: 0.85rem; color: #64748b;">Utilization</span>
                                    <span style="font-size: 0.85rem; color: ${color};">${utilization}%</span>
                                </div>
                                <div style="background: #f1f5f9; overflow: hidden;">
                                    <div style="background: ${color}; width: ${utilization}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            ${data.total > 0 ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                                    <div style="font-size: 0.85rem; color: #64748b;">
                                        <strong>Recent Tasks:</strong>
                                    </div>
                                    <div id="agent-${agentId}-tasks" style="margin-top: 0.5rem; color: #94a3b8;">
                                        ${agentTasks.slice(-3).map(t => `
                                            <div style="padding: 0.25rem 0;">• ${t.task_type} ${t.status === 'completed' ? '✅' : t.status === 'in_progress' ? '🔄' : '⏸️'}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div style="margin-top: 1rem; color: #94a3b8; font-size: 0.85rem;">
                                    No tasks assigned yet
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Auto-refresh every 15 seconds
        setInterval(loadDashboard, 15000);
        loadDashboard();
    </script>

</body>
</html>

