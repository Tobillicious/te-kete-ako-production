<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ğŸŒ¿ BMAD AUTHENTIC CULTURAL DESIGN -->
    <link rel="stylesheet" href="/css/te-kete-bmad-authentic.css"/>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Learning Dashboard - Te Kete Ako</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bmad-cream-white, #FAF9F6);
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .dashboard-header h1 {
            margin: 0 0 0.5rem;
            font-size: 2.5rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .card-title {
            color: var(--bmad-forest-green, #2F4F2F);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .card-description {
            color: var(--bmad-warm-gray, #8B7D6B);
            margin-bottom: 1rem;
        }
        
        .card-stat {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .btn {
            display: inline-block;
            background: var(--bmad-earth-brown, #8B4513);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: var(--bmad-forest-green, #2F4F2F);
            transform: translateY(-2px);
        }
        
        .progress-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .progress-section h2 {
            color: var(--bmad-forest-green, #2F4F2F);
            margin: 0 0 1.5rem;
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .progress-item:last-child {
            border-bottom: none;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            margin: 0 1rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            transition: width 0.3s ease;
        }
        
        .achievement-badge {
            background: var(--bmad-gold-excellence, #FFD700);
            color: var(--bmad-dark-text, #2D2520);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.875rem;
            display: inline-block;
            margin: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>ğŸ§‘â€ğŸ“ My Learning Dashboard</h1>
        <p id="welcome-message" style="margin: 0; opacity: 0.9;">Loading...</p>
    </div>
    
    <!-- Quick Stats -->
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-icon">ğŸ“š</div>
            <div class="card-title">Lessons Completed</div>
            <div class="card-stat" id="lessons-completed">0</div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-icon">â­</div>
            <div class="card-title">Achievements Earned</div>
            <div class="card-stat" id="achievements-earned">0</div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-icon">ğŸ¯</div>
            <div class="card-title">Current Streak</div>
            <div class="card-stat" id="current-streak">0 days</div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-icon">ğŸŒ¿</div>
            <div class="card-title">Cultural Connection</div>
            <div class="card-stat" id="cultural-score">0%</div>
        </div>
    </div>
    
    <!-- Continue Learning -->
    <div class="progress-section">
        <h2>ğŸ“– Continue Learning</h2>
        <div id="continue-learning">
            <p style="text-align: center; color: var(--bmad-warm-gray);">
                Start exploring lessons to see your progress here!
            </p>
        </div>
    </div>
    
    <!-- Achievements -->
    <div class="progress-section">
        <h2>ğŸ† Your Achievements</h2>
        <div id="achievements-list" style="text-align: center;">
            <div class="achievement-badge">ğŸŒŸ First Lesson</div>
            <div class="achievement-badge">ğŸ“š 5 Lessons Complete</div>
            <div class="achievement-badge">ğŸ”¥ 7-Day Streak</div>
            <div class="achievement-badge">ğŸŒ¿ Cultural Explorer</div>
            <div class="achievement-badge">ğŸ¯ Perfect Quiz Score</div>
            <p style="color: var(--bmad-warm-gray); margin-top: 1rem;">
                Complete lessons to unlock more achievements!
            </p>
        </div>
    </div>
    
    <!-- Recommended for You -->
    <div class="progress-section">
        <h2>âœ¨ Recommended for You</h2>
        <div class="dashboard-grid" id="recommended-lessons">
            <div style="text-align: center; color: var(--bmad-warm-gray); grid-column: 1/-1;">
                Loading personalized recommendations...
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div style="text-align: center; margin: 2rem 0;">
        <a href="/search" class="btn" style="margin: 0.5rem;">ğŸ” Explore All Lessons</a>
        <a href="/games" class="btn" style="margin: 0.5rem;">ğŸ® Play Learning Games</a>
        <a href="/my-kete" class="btn" style="margin: 0.5rem;">ğŸ’¾ My Saved Resources</a>
    </div>
    
    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://nlgldaqtubrlcqddppbq.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODkzMzksImV4cCI6MjA2ODY2NTMzOX0.IFaWqep1MBSofARiCUuzvAReC44hwGnmKOMNSd55nIM'
        );
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStudentDashboard();
        });
        
        async function loadStudentDashboard() {
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error || !user) {
                    window.location.href = '/login.html?redirect=/student-dashboard.html';
                    return;
                }
                
                // Get user profile
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                // Update welcome message
                const firstName = profile?.first_name || profile?.display_name || 'Student';
                document.getElementById('welcome-message').textContent = 
                    `Kia ora ${firstName}! Ready to learn?`;
                
                // Load progress data
                await loadProgress(user.id);
                await loadRecommendations(profile);
                
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }
        
        async function loadProgress(userId) {
            // Get student progress
            const { data: progress } = await supabaseClient
                .from('student_progress')
                .select('*')
                .eq('student_id', userId);
            
            // Calculate stats
            const completed = progress?.filter(p => p.progress_percentage === 100).length || 0;
            const inProgress = progress?.filter(p => p.progress_percentage > 0 && p.progress_percentage < 100) || [];
            
            document.getElementById('lessons-completed').textContent = completed;
            
            // Calculate streak (simplified)
            document.getElementById('current-streak').textContent = '0 days';
            
            // Cultural score
            const culturalAvg = progress?.reduce((sum, p) => sum + (p.cultural_engagement_score || 0), 0) / (progress?.length || 1);
            document.getElementById('cultural-score').textContent = Math.round(culturalAvg || 0) + '%';
            
            // Show in-progress lessons
            if (inProgress.length > 0) {
                const continueEl = document.getElementById('continue-learning');
                continueEl.innerHTML = inProgress.slice(0, 3).map(p => `
                    <div class="progress-item">
                        <span style="font-weight: 600;">Lesson in progress</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${p.progress_percentage}%"></div>
                        </div>
                        <span>${p.progress_percentage}%</span>
                    </div>
                `).join('');
            }
        }
        
        async function loadRecommendations(profile) {
            // Get recommended lessons based on year level
            const yearLevel = profile?.year_level;
            
            const { data: lessons } = await supabaseClient
                .from('graphrag_resources')
                .select('title, file_path, subject, quality_score')
                .eq('resource_type', 'lesson')
                .gte('quality_score', 85)
                .limit(6);
            
            const recommendedEl = document.getElementById('recommended-lessons');
            
            if (!lessons || lessons.length === 0) {
                recommendedEl.innerHTML = '<p style="text-align: center; color: var(--bmad-warm-gray);">Explore lessons to get recommendations!</p>';
                return;
            }
            
            recommendedEl.innerHTML = lessons.map(lesson => `
                <div class="dashboard-card">
                    <div class="card-icon">ğŸ“–</div>
                    <div class="card-title" style="font-size: 1.1rem;">${lesson.title}</div>
                    <div class="card-description">${lesson.subject || 'General'}</div>
                    <a href="${lesson.file_path}" class="btn" style="font-size: 0.9rem;">Start Lesson â†’</a>
                </div>
            `).join('');
        }
    </script>
    
    <!-- Sidebar Auto-Loader -->
    <script src="/js/sidebar-auto-loader.js" defer></script>
</body>
</html>