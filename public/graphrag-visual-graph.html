<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Visual Knowledge Graph | GraphRAG Intelligence | Te Kete Ako</title>    <!-- üé® ULTIMATE BEAUTY SYSTEM - Te Kete Ako Design Excellence --> <link rel="stylesheet" href="/css/te-kete-ultimate-beauty-system.css"> <script src="https://cdn.tailwindcss.com"></script> <script src="/tailwind.config.ultimate.js"></script> <!-- END ULTIMATE BEAUTY SYSTEM --><script src="https://d3js.org/d3.v7.min.js"></script>    <style>        body { background: #0f172a; color: #e2e8f0; margin: 0; padding: 0; overflow: hidden; }        .controls { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(30, 41, 59, 0.95); padding: 1.5rem; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); max-width: 350px; }        .graph-container { width: 100vw; height: 100vh; }        .node { cursor: pointer; stroke: #1e293b; stroke-width: 2px; }        .node:hover { stroke: #fbbf24; stroke-width: 3px; }        .link { stroke: #475569; stroke-opacity: 0.6; }        .link-cultural { stroke: #a855f7; stroke-width: 2px; }        .link-prerequisite { stroke: #10b981; stroke-width: 2px; stroke-dasharray: 5,5; }        .link-cross-subject { stroke: #f59e0b; stroke-width: 2.5px; }        .node-label { fill: #e2e8f0; font-size: 11px; font-weight: 600; pointer-events: none; text-shadow: 0 0 4px #0f172a; }        .filter-btn { display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; }        .filter-btn:hover { background: #2563eb; transform: translateY(-1px); }        .filter-btn.active { background: #10b981; }        .stats { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #334155; font-size: 0.9rem; }        h2 { margin: 0 0 1rem 0; font-size: 1.5rem; color: #a855f7; }        .legend { margin-top: 1rem; }        .legend-item { display: flex; align-items: center; margin: 0.5rem 0; font-size: 0.85rem; }        .legend-color { width: 20px; height: 20px; border-radius: 4px; margin-right: 0.5rem; }        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }        .spinner { border: 4px solid #334155; border-top: 4px solid #a855f7; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }    </style><!-- Professional Design System --></head><body class="pattern-koru-subtle"> <!-- üé® ULTIMATE BEAUTY: Navigation --> <div id="nav-container"></div> <script>   fetch('/components/navigation-standard.html')     .then(r => r.text())     .then(html => document.getElementById('nav-container').innerHTML = html); </script>    <!-- Whakataukƒ´ Banner -->    <div style="position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f5e6d3 0%, #d4a574 100%); padding: 1rem; text-align: center; z-index: 99; border-bottom: 3px solid #1a4d2e;">        <p style="margin: 0; color: #0f2818; font-style: italic; font-weight: 600; font-size: 0.95rem;">            "Ehara taku toa i te toa takitahi, engari he toa takitini" ‚Äî Success is not the work of one, but the work of many        </p>    </div>    <div class="controls" style="top: 70px;">        <h2>üß† Knowledge Graph</h2>        <div style="margin-bottom: 1rem;">            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">View Mode:</label>            <button class="filter-btn active" onclick="loadGraph('science')">üî¨ Science</button>            <button class="filter-btn" onclick="loadGraph('mathematics')">üìä Mathematics</button>            <button class="filter-btn" onclick="loadGraph('english')">üìù English</button>            <button class="filter-btn" onclick="loadGraph('cultural')">üåø Cultural</button>            <button class="filter-btn" onclick="loadGraph('cross-subject')">üîó Cross-Subject</button>        </div>        <div class="legend">            <div style="font-weight: 600; margin-bottom: 0.5rem;">Relationship Types:</div>            <div class="legend-item">                <div class="legend-color" style="background: #a855f7;"></div>                Cultural Connection            </div>            <div class="legend-item">                <div class="legend-color" style="background: #10b981; opacity: 0.7;"></div>                Prerequisite Chain            </div>            <div class="legend-item">                <div class="legend-color" style="background: #f59e0b;"></div>                Cross-Curricular            </div>            <div class="legend-item">                <div class="legend-color" style="background: #475569; opacity: 0.6;"></div>                Related Content            </div>        </div>        <div class="stats" id="stats">            <div>Nodes: <strong id="node-count">0</strong></div>            <div>Connections: <strong id="link-count">0</strong></div>            <div>Avg Confidence: <strong id="avg-confidence">0%</strong></div>        </div>        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #334155;">            <button class="filter-btn" style="width: 100%; background: #1e293b;" onclick="window.location.href='/cross-subject-discovery.html'">                ‚Üê Back to Discovery            </button>        </div>    </div>    <div id="loading" class="loading">        <div class="spinner"></div>        <p>Loading GraphRAG data...</p>    </div>    <svg class="graph-container" id="graph"></svg>    <script>    const SUPABASE_URL = 'https://nlgldaqtubrlcqddppbq.supabase.co';    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sZ2xkYXF0dWJybGNxZGRwcGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5ODgxMTksImV4cCI6MjA1MjU2NDExOX0.gN5RGe7kGmxj4-yI1xnDuCuKUPFDh4f-8CQqQdqrGq0';    let simulation;    let currentMode = 'science';    const subjectColors = {        'Science': '#0891b2',        'Mathematics': '#6366f1',        'English': '#dc2626',        'Social Studies': '#059669',        'Digital Tech': '#10b981',        'Health & PE': '#f97316',        'Te Ao MƒÅori': '#a855f7',        'General': '#64748b'    };    async function loadGraph(mode) {        currentMode = mode;        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));        event.target.classList.add('active');        document.getElementById('loading').style.display = 'block';        try {            let query;            if (mode === 'science') {                query = `relationship_type=in.(related_content,prerequisite)&limit=50`;            } else if (mode === 'mathematics') {                query = `relationship_type=eq.prerequisite&limit=40`;            } else if (mode === 'english') {                query = `relationship_type=in.(related_content,shared_cultural_element)&limit=40`;            } else if (mode === 'cultural') {                query = `relationship_type=eq.shared_cultural_element&confidence=gte.0.9&limit=30`;            } else if (mode === 'cross-subject') {                query = `relationship_type=in.(cross_curricular_link,shared_cultural_element)&confidence=gte.0.85&limit=35`;            }            const response = await fetch(                `${SUPABASE_URL}/rest/v1/graphrag_relationships?select=source_path,target_path,relationship_type,confidence&${query}&order=confidence.desc`,                { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }            );            const relationships = await response.json();            console.log(`Loaded ${relationships.length} relationships for ${mode}`);            // Get unique paths            const paths = [...new Set([                ...relationships.map(r => r.source_path),                ...relationships.map(r => r.target_path)            ])].slice(0, 50);            // Fetch resource details            const pathFilter = paths.slice(0, 50).map(p => `"${p}"`).join(',');            const resourceResponse = await fetch(                `${SUPABASE_URL}/rest/v1/graphrag_resources?select=file_path,title,subject&file_path=in.(${pathFilter})`,                { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }            );            const resources = await resourceResponse.json();            const resourceMap = {};            resources.forEach(r => {                resourceMap[r.file_path] = r;            });            // Build graph data            const nodes = resources.map(r => ({                id: r.file_path,                label: r.title?.substring(0, 30) || 'Resource',                subject: r.subject?.split(',')[0] || 'General',                fullTitle: r.title            }));            const links = relationships                .filter(r => resourceMap[r.source_path] && resourceMap[r.target_path])                .map(r => ({                    source: r.source_path,                    target: r.target_path,                    type: r.relationship_type,                    confidence: r.confidence                }));            renderGraph({ nodes, links });        } catch (error) {            console.error('Error loading graph:', error);            document.getElementById('loading').innerHTML = `                <div style="color: #ef4444;">                    <div style="font-size: 3rem;">‚ö†Ô∏è</div>                    <p>Error loading graph</p>                </div>            `;        }    }    function renderGraph(data) {        document.getElementById('loading').style.display = 'none';        const width = window.innerWidth;        const height = window.innerHeight;        const svg = d3.select('#graph');        svg.selectAll('*').remove();        const g = svg.append('g');        // Add zoom        const zoom = d3.zoom()            .scaleExtent([0.3, 3])            .on('zoom', (event) => g.attr('transform', event.transform));        svg.call(zoom);        // Create simulation        simulation = d3.forceSimulation(data.nodes)            .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))            .force('charge', d3.forceManyBody().strength(-300))            .force('center', d3.forceCenter(width / 2, height / 2))            .force('collision', d3.forceCollide().radius(40));        // Draw links        const link = g.append('g')            .selectAll('line')            .data(data.links)            .join('line')            .attr('class', d => {                if (d.type === 'shared_cultural_element') return 'link link-cultural';                if (d.type === 'prerequisite') return 'link link-prerequisite';                if (d.type === 'cross_curricular_link') return 'link link-cross-subject';                return 'link';            })            .attr('stroke-width', d => Math.max(1, d.confidence * 3));        // Draw nodes        const node = g.append('g')            .selectAll('circle')            .data(data.nodes)            .join('circle')            .attr('class', 'node')            .attr('r', 12)            .attr('fill', d => subjectColors[d.subject] || subjectColors.General)            .call(drag(simulation));        // Add labels        const label = g.append('g')            .selectAll('text')            .data(data.nodes)            .join('text')            .attr('class', 'node-label')            .text(d => d.label)            .attr('dx', 15)            .attr('dy', 4);        // Tooltips        node.append('title').text(d => `${d.fullTitle}\n${d.subject}`);        // Update positions        simulation.on('tick', () => {            link                .attr('x1', d => d.source.x)                .attr('y1', d => d.source.y)                .attr('x2', d => d.target.x)                .attr('y2', d => d.target.y);            node                .attr('cx', d => d.x)                .attr('cy', d => d.y);            label                .attr('x', d => d.x)                .attr('y', d => d.y);        });        // Update stats        document.getElementById('node-count').textContent = data.nodes.length;        document.getElementById('link-count').textContent = data.links.length;        const avgConf = data.links.reduce((sum, l) => sum + l.confidence, 0) / data.links.length;        document.getElementById('avg-confidence').textContent = Math.round(avgConf * 100) + '%';    }    function drag(simulation) {        function dragstarted(event) {            if (!event.active) simulation.alphaTarget(0.3).restart();            event.subject.fx = event.subject.x;            event.subject.fy = event.subject.y;        }        function dragged(event) {            event.subject.fx = event.x;            event.subject.fy = event.y;        }        function dragended(event) {            if (!event.active) simulation.alphaTarget(0);            event.subject.fx = null;            event.subject.fy = null;        }        return d3.drag()            .on('start', dragstarted)            .on('drag', dragged)            .on('end', dragended);    }    // Load default view    loadGraph('science');    </script><!-- üé® ULTIMATE BEAUTY SYSTEM: Complete UX --><!-- Footer --><div id="footer-container"></div><script>  fetch('/components/footer.html').then(r=>r.text()).then(html=>{    document.getElementById('footer-container').innerHTML=html;  });</script><!-- Mobile Navigation --><div id="mobile-nav-bottom"></div><script>  fetch('/components/mobile-bottom-nav.html').then(r=>r.text()).then(html=>{    document.getElementById('mobile-nav-bottom').innerHTML=html;  });</script><!-- Floating Action Button (Help) --><div id="fab-quick-actions"></div><script>  fetch('/components/quick-actions-fab.html').then(r=>r.text()).then(html=>{    document.getElementById('fab-quick-actions').innerHTML=html;  });</script><!-- üé® ULTIMATE BEAUTY: Framer Cultural Gestures --><script src="/js/framer-cultural-gestures-ultimate.js" defer></script><!-- üìä ULTIMATE BEAUTY: PostHog Analytics (Privacy-First) --><script src="/js/posthog-analytics.js" defer></script></body></html>